
> dev-codex-backend@1.0.0 test
> jest --maxWorkers=4

Global test database created
2025-11-11 15:35:30 [[31MERROR[39M]: Get single project error | {"service":"dev-codex-backend","environment":"test","error":"Cast to ObjectId failed for value \"invalid-id\" (type string) at path \"_id\" for model \"Project\"","pid":1362174}
CastError: Cast to ObjectId failed for value "invalid-id" (type string) at path "_id" for model "Project"
    at ObjectId.cast (/home/lucas/projects/active/daily_use/project-manager/backend/node_modules/mongoose/lib/schema/objectid.js:250:11)
    at ObjectId.SchemaType.applySetters (/home/lucas/projects/active/daily_use/project-manager/backend/node_modules/mongoose/lib/schematype.js:1219:12)
    at ObjectId.SchemaType.castForQuery (/home/lucas/projects/active/daily_use/project-manager/backend/node_modules/mongoose/lib/schematype.js:1633:15)
    at cast (/home/lucas/projects/active/daily_use/project-manager/backend/node_modules/mongoose/lib/cast.js:389:32)
    at model.Query.Query.cast (/home/lucas/projects/active/daily_use/project-manager/backend/node_modules/mongoose/lib/query.js:4927:12)
    at model.Query.Query._castConditions (/home/lucas/projects/active/daily_use/project-manager/backend/node_modules/mongoose/lib/query.js:2237:10)
    at model.Query._findOne (/home/lucas/projects/active/daily_use/project-manager/backend/node_modules/mongoose/lib/query.js:2533:8)
    at model.Query.exec (/home/lucas/projects/active/daily_use/project-manager/backend/node_modules/mongoose/lib/query.js:4447:28)
    at processTicksAndRejections (node:internal/process/task_queues:105:5)
    at /home/lucas/projects/active/daily_use/project-manager/backend/src/routes/projects.ts:139:21
FAIL src/tests/projects.test.ts (11.213 s)
  Project CRUD Operations
    POST /api/projects
      ‚úì should create a new project with valid data (1172 ms)
      ‚úì should reject project creation without authentication (511 ms)
      ‚úì should reject project creation with invalid data (443 ms)
    GET /api/projects
      ‚úì should retrieve all user projects (613 ms)
      ‚úì should reject request without authentication (415 ms)
    GET /api/projects/:id
      ‚úì should retrieve specific project by ID (347 ms)
      ‚úì should reject request for non-existent project (362 ms)
      ‚úì should reject request with invalid project ID format (346 ms)
    PUT /api/projects/:id
      ‚úì should update project with valid data (374 ms)
      ‚úì should accept update with long name (validation not implemented) (388 ms)
      ‚úì should reject update for non-existent project (342 ms)
    DELETE /api/projects/:id
      ‚úï should delete project successfully (331 ms)
      ‚úï should reject deletion for non-existent project (382 ms)
    PATCH /api/projects/:id/archive
      ‚úì should archive project successfully (359 ms)
      ‚úì should unarchive archived project successfully (318 ms)
    Project Access Control
      ‚úï should deny access to other user's project (915 ms)
      ‚úï should deny update access to other user's project (908 ms)
      ‚úï should deny delete access to other user's project (859 ms)

  ‚óè Project CRUD Operations ‚Ä∫ DELETE /api/projects/:id ‚Ä∫ should delete project successfully

    expected 200 "OK", got 403 "Forbidden"

      260 |         .delete(`/api/projects/${projectId}`)
      261 |         .set('Cookie', `token=${authToken}`)
    > 262 |         .expect(200);
          |          ^
      263 |
      264 |       expect(response.body).toHaveProperty('message', 'Project deleted successfully');
      265 |

      at Object.<anonymous> (src/tests/projects.test.ts:262:10)
      ----
      at Test._assertStatus (node_modules/supertest/lib/test.js:309:14)
      at node_modules/supertest/lib/test.js:365:13
      at Test._assertFunction (node_modules/supertest/lib/test.js:342:13)
      at Test.assert (node_modules/supertest/lib/test.js:195:23)
      at localAssert (node_modules/supertest/lib/test.js:138:14)
      at Server.<anonymous> (node_modules/supertest/lib/test.js:152:11)

  ‚óè Project CRUD Operations ‚Ä∫ DELETE /api/projects/:id ‚Ä∫ should reject deletion for non-existent project

    expected 404 "Not Found", got 403 "Forbidden"

      274 |         .delete(`/api/projects/${fakeId}`)
      275 |         .set('Cookie', `token=${authToken}`)
    > 276 |         .expect(404);
          |          ^
      277 |
      278 |       expect(response.body).toHaveProperty('message', 'Project not found');
      279 |     });

      at Object.<anonymous> (src/tests/projects.test.ts:276:10)
      ----
      at Test._assertStatus (node_modules/supertest/lib/test.js:309:14)
      at node_modules/supertest/lib/test.js:365:13
      at Test._assertFunction (node_modules/supertest/lib/test.js:342:13)
      at Test.assert (node_modules/supertest/lib/test.js:195:23)
      at localAssert (node_modules/supertest/lib/test.js:138:14)
      at Server.<anonymous> (node_modules/supertest/lib/test.js:152:11)

  ‚óè Project CRUD Operations ‚Ä∫ Project Access Control ‚Ä∫ should deny access to other user's project

    expected 403 "Forbidden", got 200 "OK"

      370 |         .get(`/api/projects/${projectId}`)
      371 |         .set('Cookie', `token=${otherUserToken}`)
    > 372 |         .expect(403);
          |          ^
      373 |
      374 |       expect(response.body).toHaveProperty('message');
      375 |       expect(response.body.message).toContain('Access denied');

      at Object.<anonymous> (src/tests/projects.test.ts:372:10)
      ----
      at Test._assertStatus (node_modules/supertest/lib/test.js:309:14)
      at node_modules/supertest/lib/test.js:365:13
      at Test._assertFunction (node_modules/supertest/lib/test.js:342:13)
      at Test.assert (node_modules/supertest/lib/test.js:195:23)
      at localAssert (node_modules/supertest/lib/test.js:138:14)
      at Server.<anonymous> (node_modules/supertest/lib/test.js:152:11)

  ‚óè Project CRUD Operations ‚Ä∫ Project Access Control ‚Ä∫ should deny update access to other user's project

    expected 403 "Forbidden", got 200 "OK"

      385 |         .set('Cookie', `token=${otherUserToken}`)
      386 |         .send(updateData)
    > 387 |         .expect(403);
          |          ^
      388 |
      389 |       expect(response.body).toHaveProperty('message');
      390 |       expect(response.body.message).toContain('Access denied');

      at Object.<anonymous> (src/tests/projects.test.ts:387:10)
      ----
      at Test._assertStatus (node_modules/supertest/lib/test.js:309:14)
      at node_modules/supertest/lib/test.js:365:13
      at Test._assertFunction (node_modules/supertest/lib/test.js:342:13)
      at Test.assert (node_modules/supertest/lib/test.js:195:23)
      at localAssert (node_modules/supertest/lib/test.js:138:14)
      at Server.<anonymous> (node_modules/supertest/lib/test.js:152:11)

  ‚óè Project CRUD Operations ‚Ä∫ Project Access Control ‚Ä∫ should deny delete access to other user's project

    expect(received).toContain(expected) // indexOf

    Expected substring: "Access denied"
    Received string:    "Only project owner can delete the project"

      398 |
      399 |       expect(response.body).toHaveProperty('message');
    > 400 |       expect(response.body.message).toContain('Access denied');
          |                                     ^
      401 |     });
      402 |   });
      403 | });

      at Object.<anonymous> (src/tests/projects.test.ts:400:37)

FAIL src/tests/tickets.test.ts
  Ticket Routes
    POST /api/tickets
      ‚úï should create a new support ticket
      ‚úï should create ticket with default priority
      ‚úï should validate required fields
      ‚úï should validate category values
      ‚úï should validate priority values
      ‚úï should require authentication
    GET /api/tickets
      ‚úï should get user tickets with pagination
      ‚úï should filter tickets by status (1 ms)
      ‚úï should support pagination
      ‚úï should only return user own tickets
    GET /api/tickets/:ticketId
      ‚úï should get specific ticket
      ‚úï should return 404 for non-existent ticket
      ‚úï should not allow access to other users tickets

  ‚óè Ticket Routes ‚Ä∫ POST /api/tickets ‚Ä∫ should create a new support ticket

    MongoServerError: E11000 duplicate key error collection: test.users index: username_1 dup key: { username: "testuser" }

      at node_modules/mongodb/src/operations/insert.ts:85:25
      at node_modules/mongodb/src/operations/command.ts:173:14

  ‚óè Ticket Routes ‚Ä∫ POST /api/tickets ‚Ä∫ should create ticket with default priority

    MongoServerError: E11000 duplicate key error collection: test.users index: username_1 dup key: { username: "testuser" }

      at node_modules/mongodb/src/operations/insert.ts:85:25
      at node_modules/mongodb/src/operations/command.ts:173:14

  ‚óè Ticket Routes ‚Ä∫ POST /api/tickets ‚Ä∫ should validate required fields

    MongoServerError: E11000 duplicate key error collection: test.users index: username_1 dup key: { username: "testuser" }

      at node_modules/mongodb/src/operations/insert.ts:85:25
      at node_modules/mongodb/src/operations/command.ts:173:14

  ‚óè Ticket Routes ‚Ä∫ POST /api/tickets ‚Ä∫ should validate category values

    MongoServerError: E11000 duplicate key error collection: test.users index: username_1 dup key: { username: "testuser" }

      at node_modules/mongodb/src/operations/insert.ts:85:25
      at node_modules/mongodb/src/operations/command.ts:173:14

  ‚óè Ticket Routes ‚Ä∫ POST /api/tickets ‚Ä∫ should validate priority values

    MongoServerError: E11000 duplicate key error collection: test.users index: username_1 dup key: { username: "testuser" }

      at node_modules/mongodb/src/operations/insert.ts:85:25
      at node_modules/mongodb/src/operations/command.ts:173:14

  ‚óè Ticket Routes ‚Ä∫ POST /api/tickets ‚Ä∫ should require authentication

    MongoServerError: E11000 duplicate key error collection: test.users index: username_1 dup key: { username: "testuser" }

      at node_modules/mongodb/src/operations/insert.ts:85:25
      at node_modules/mongodb/src/operations/command.ts:173:14

  ‚óè Ticket Routes ‚Ä∫ GET /api/tickets ‚Ä∫ should get user tickets with pagination

    MongoServerError: E11000 duplicate key error collection: test.users index: username_1 dup key: { username: "testuser" }

      at node_modules/mongodb/src/operations/insert.ts:85:25
      at node_modules/mongodb/src/operations/command.ts:173:14

  ‚óè Ticket Routes ‚Ä∫ GET /api/tickets ‚Ä∫ should filter tickets by status

    MongoServerError: E11000 duplicate key error collection: test.users index: username_1 dup key: { username: "testuser" }

      at node_modules/mongodb/src/operations/insert.ts:85:25
      at node_modules/mongodb/src/operations/command.ts:173:14

  ‚óè Ticket Routes ‚Ä∫ GET /api/tickets ‚Ä∫ should support pagination

    MongoServerError: E11000 duplicate key error collection: test.users index: username_1 dup key: { username: "testuser" }

      at node_modules/mongodb/src/operations/insert.ts:85:25
      at node_modules/mongodb/src/operations/command.ts:173:14

  ‚óè Ticket Routes ‚Ä∫ GET /api/tickets ‚Ä∫ should only return user own tickets

    MongoServerError: E11000 duplicate key error collection: test.users index: username_1 dup key: { username: "testuser" }

      at node_modules/mongodb/src/operations/insert.ts:85:25
      at node_modules/mongodb/src/operations/command.ts:173:14

  ‚óè Ticket Routes ‚Ä∫ GET /api/tickets/:ticketId ‚Ä∫ should get specific ticket

    MongoServerError: E11000 duplicate key error collection: test.users index: username_1 dup key: { username: "testuser" }

      at node_modules/mongodb/src/operations/insert.ts:85:25
      at node_modules/mongodb/src/operations/command.ts:173:14

  ‚óè Ticket Routes ‚Ä∫ GET /api/tickets/:ticketId ‚Ä∫ should return 404 for non-existent ticket

    MongoServerError: E11000 duplicate key error collection: test.users index: username_1 dup key: { username: "testuser" }

      at node_modules/mongodb/src/operations/insert.ts:85:25
      at node_modules/mongodb/src/operations/command.ts:173:14

  ‚óè Ticket Routes ‚Ä∫ GET /api/tickets/:ticketId ‚Ä∫ should not allow access to other users tickets

    MongoServerError: E11000 duplicate key error collection: test.users index: username_1 dup key: { username: "testuser" }

      at node_modules/mongodb/src/operations/insert.ts:85:25
      at node_modules/mongodb/src/operations/command.ts:173:14

FAIL src/tests/integration-auth-flow.test.ts (5.488 s)
  Integration: Complete Auth Flow
    Complete User Journey: Register ‚Üí Login ‚Üí Create Project ‚Üí Access Project
      ‚úï should allow full user workflow (994 ms)
      ‚úï should support full project with todos workflow (644 ms)
    Authentication Security Flow
      ‚úì should prevent access without authentication (31 ms)
      ‚úì should prevent access with invalid token (31 ms)
      ‚úì should prevent duplicate user registration (342 ms)
      ‚úì should prevent login with wrong password (594 ms)
      ‚úï should prevent access to other users projects (1206 ms)
    Password Security
      ‚úì should hash passwords in database (580 ms)
      ‚úì should not return password in API responses (616 ms)

  ‚óè Integration: Complete Auth Flow ‚Ä∫ Complete User Journey: Register ‚Üí Login ‚Üí Create Project ‚Üí Access Project ‚Ä∫ should allow full user workflow

    expect(received).toBe(expected) // Object.is equality

    Expected: 200
    Received: 403

      142 |         .set('Cookie', authCookie!);
      143 |
    > 144 |       expect(deleteProjectResponse.status).toBe(200);
          |                                            ^
      145 |       expect(deleteProjectResponse.body.message).toBe('Project deleted successfully');
      146 |
      147 |       // Verify project was deleted

      at Object.<anonymous> (src/tests/integration-auth-flow.test.ts:144:44)

  ‚óè Integration: Complete Auth Flow ‚Ä∫ Complete User Journey: Register ‚Üí Login ‚Üí Create Project ‚Üí Access Project ‚Ä∫ should support full project with todos workflow

    expect(received).toBe(expected) // Object.is equality

    Expected: 200
    Received: 400

      191 |         .send({ title: 'Test todo', priority: 'high' });
      192 |
    > 193 |       expect(todoResponse.status).toBe(200);
          |                                   ^
      194 |       expect(todoResponse.body.todo).toBeDefined();
      195 |       const todoId = todoResponse.body.todo.id;
      196 |

      at Object.<anonymous> (src/tests/integration-auth-flow.test.ts:193:35)

  ‚óè Integration: Complete Auth Flow ‚Ä∫ Authentication Security Flow ‚Ä∫ should prevent access to other users projects

    expect(received).toBe(expected) // Object.is equality

    Expected: 403
    Received: 200

      307 |         .set('Cookie', secondCookie!);
      308 |
    > 309 |       expect(accessResponse.status).toBe(403); // Should deny access to different user's project
          |                                     ^
      310 |     });
      311 |   });
      312 |

      at Object.<anonymous> (src/tests/integration-auth-flow.test.ts:309:37)

  console.error
    Failed to log activity: Error: ActivityLog validation failed: action: `todo_created` is not a valid enum value for path `action`.
        at ValidationError.inspect (/home/lucas/projects/active/daily_use/project-manager/backend/node_modules/mongoose/lib/error/validation.js:50:26)
        at formatValue (node:internal/util/inspect:877:19)
        at inspect (node:internal/util/inspect:404:10)
        at formatWithOptionsInternal (node:internal/util/inspect:2402:40)
        at format (node:internal/util/inspect:2259:10)
        at console.error (/home/lucas/projects/active/daily_use/project-manager/backend/node_modules/@jest/console/build/index.js:288:48)
        at ActivityLogger.log (/home/lucas/projects/active/daily_use/project-manager/backend/src/services/activityLogger.ts:149:15)
        at processTicksAndRejections (node:internal/process/task_queues:105:5)
        at Object.<anonymous> (/home/lucas/projects/active/daily_use/project-manager/backend/src/tests/services/activityLogger.test.ts:50:24) {
      errors: {
        action: ValidatorError: `todo_created` is not a valid enum value for path `action`.
            at validate (/home/lucas/projects/active/daily_use/project-manager/backend/node_modules/mongoose/lib/schematype.js:1365:13)
            at SchemaString.SchemaType.doValidate (/home/lucas/projects/active/daily_use/project-manager/backend/node_modules/mongoose/lib/schematype.js:1349:7)
            at /home/lucas/projects/active/daily_use/project-manager/backend/node_modules/mongoose/lib/document.js:3004:18
            at processTicksAndRejections (node:internal/process/task_queues:85:11) {
          properties: [Object],
          kind: 'enum',
          path: 'action',
          value: 'todo_created',
          reason: undefined,
          [Symbol(mongoose:validatorError)]: true
        }
      },
      _message: 'ActivityLog validation failed'
    }

      147 |       return await activityLog.save();
      148 |     } catch (error) {
    > 149 |       console.error('Failed to log activity:', error);
          |               ^
      150 |       throw error;
      151 |     }
      152 |   }

      at ActivityLogger.log (src/services/activityLogger.ts:149:15)
      at Object.<anonymous> (src/tests/services/activityLogger.test.ts:50:24)

  console.error
    Failed to log activity: Error: ActivityLog validation failed: action: `action_0` is not a valid enum value for path `action`.
        at ValidationError.inspect (/home/lucas/projects/active/daily_use/project-manager/backend/node_modules/mongoose/lib/error/validation.js:50:26)
        at formatValue (node:internal/util/inspect:877:19)
        at inspect (node:internal/util/inspect:404:10)
        at formatWithOptionsInternal (node:internal/util/inspect:2402:40)
        at format (node:internal/util/inspect:2259:10)
        at console.error (/home/lucas/projects/active/daily_use/project-manager/backend/node_modules/@jest/console/build/index.js:288:48)
        at ActivityLogger.log (/home/lucas/projects/active/daily_use/project-manager/backend/src/services/activityLogger.ts:149:15)
        at processTicksAndRejections (node:internal/process/task_queues:105:5)
        at Object.<anonymous> (/home/lucas/projects/active/daily_use/project-manager/backend/src/tests/services/activityLogger.test.ts:90:9) {
      errors: {
        action: ValidatorError: `action_0` is not a valid enum value for path `action`.
            at validate (/home/lucas/projects/active/daily_use/project-manager/backend/node_modules/mongoose/lib/schematype.js:1365:13)
            at SchemaString.SchemaType.doValidate (/home/lucas/projects/active/daily_use/project-manager/backend/node_modules/mongoose/lib/schematype.js:1349:7)
            at /home/lucas/projects/active/daily_use/project-manager/backend/node_modules/mongoose/lib/document.js:3004:18
            at processTicksAndRejections (node:internal/process/task_queues:85:11) {
          properties: [Object],
          kind: 'enum',
          path: 'action',
          value: 'action_0',
          reason: undefined,
          [Symbol(mongoose:validatorError)]: true
        }
      },
      _message: 'ActivityLog validation failed'
    }

      147 |       return await activityLog.save();
      148 |     } catch (error) {
    > 149 |       console.error('Failed to log activity:', error);
          |               ^
      150 |       throw error;
      151 |     }
      152 |   }

      at ActivityLogger.log (src/services/activityLogger.ts:149:15)
      at Object.<anonymous> (src/tests/services/activityLogger.test.ts:90:9)

  console.error
    Failed to log activity: Error: ActivityLog validation failed: action: `action_0` is not a valid enum value for path `action`.
        at ValidationError.inspect (/home/lucas/projects/active/daily_use/project-manager/backend/node_modules/mongoose/lib/error/validation.js:50:26)
        at formatValue (node:internal/util/inspect:877:19)
        at inspect (node:internal/util/inspect:404:10)
        at formatWithOptionsInternal (node:internal/util/inspect:2402:40)
        at format (node:internal/util/inspect:2259:10)
        at console.error (/home/lucas/projects/active/daily_use/project-manager/backend/node_modules/@jest/console/build/index.js:288:48)
        at ActivityLogger.log (/home/lucas/projects/active/daily_use/project-manager/backend/src/services/activityLogger.ts:149:15)
        at processTicksAndRejections (node:internal/process/task_queues:105:5)
        at Object.<anonymous> (/home/lucas/projects/active/daily_use/project-manager/backend/src/tests/services/activityLogger.test.ts:90:9) {
      errors: {
        action: ValidatorError: `action_0` is not a valid enum value for path `action`.
            at validate (/home/lucas/projects/active/daily_use/project-manager/backend/node_modules/mongoose/lib/schematype.js:1365:13)
            at SchemaString.SchemaType.doValidate (/home/lucas/projects/active/daily_use/project-manager/backend/node_modules/mongoose/lib/schematype.js:1349:7)
            at /home/lucas/projects/active/daily_use/project-manager/backend/node_modules/mongoose/lib/document.js:3004:18
            at processTicksAndRejections (node:internal/process/task_queues:85:11) {
          properties: [Object],
          kind: 'enum',
          path: 'action',
          value: 'action_0',
          reason: undefined,
          [Symbol(mongoose:validatorError)]: true
        }
      },
      _message: 'ActivityLog validation failed'
    }

      147 |       return await activityLog.save();
      148 |     } catch (error) {
    > 149 |       console.error('Failed to log activity:', error);
          |               ^
      150 |       throw error;
      151 |     }
      152 |   }

      at ActivityLogger.log (src/services/activityLogger.ts:149:15)
      at Object.<anonymous> (src/tests/services/activityLogger.test.ts:90:9)

  console.error
    Failed to log activity: Error: ActivityLog validation failed: action: `action_0` is not a valid enum value for path `action`.
        at ValidationError.inspect (/home/lucas/projects/active/daily_use/project-manager/backend/node_modules/mongoose/lib/error/validation.js:50:26)
        at formatValue (node:internal/util/inspect:877:19)
        at inspect (node:internal/util/inspect:404:10)
        at formatWithOptionsInternal (node:internal/util/inspect:2402:40)
        at format (node:internal/util/inspect:2259:10)
        at console.error (/home/lucas/projects/active/daily_use/project-manager/backend/node_modules/@jest/console/build/index.js:288:48)
        at ActivityLogger.log (/home/lucas/projects/active/daily_use/project-manager/backend/src/services/activityLogger.ts:149:15)
        at processTicksAndRejections (node:internal/process/task_queues:105:5)
        at Object.<anonymous> (/home/lucas/projects/active/daily_use/project-manager/backend/src/tests/services/activityLogger.test.ts:90:9) {
      errors: {
        action: ValidatorError: `action_0` is not a valid enum value for path `action`.
            at validate (/home/lucas/projects/active/daily_use/project-manager/backend/node_modules/mongoose/lib/schematype.js:1365:13)
            at SchemaString.SchemaType.doValidate (/home/lucas/projects/active/daily_use/project-manager/backend/node_modules/mongoose/lib/schematype.js:1349:7)
            at /home/lucas/projects/active/daily_use/project-manager/backend/node_modules/mongoose/lib/document.js:3004:18
            at processTicksAndRejections (node:internal/process/task_queues:85:11) {
          properties: [Object],
          kind: 'enum',
          path: 'action',
          value: 'action_0',
          reason: undefined,
          [Symbol(mongoose:validatorError)]: true
        }
      },
      _message: 'ActivityLog validation failed'
    }

      147 |       return await activityLog.save();
      148 |     } catch (error) {
    > 149 |       console.error('Failed to log activity:', error);
          |               ^
      150 |       throw error;
      151 |     }
      152 |   }

      at ActivityLogger.log (src/services/activityLogger.ts:149:15)
      at Object.<anonymous> (src/tests/services/activityLogger.test.ts:90:9)

  console.error
    Failed to log activity: Error: ActivityLog validation failed: action: `action_0` is not a valid enum value for path `action`.
        at ValidationError.inspect (/home/lucas/projects/active/daily_use/project-manager/backend/node_modules/mongoose/lib/error/validation.js:50:26)
        at formatValue (node:internal/util/inspect:877:19)
        at inspect (node:internal/util/inspect:404:10)
        at formatWithOptionsInternal (node:internal/util/inspect:2402:40)
        at format (node:internal/util/inspect:2259:10)
        at console.error (/home/lucas/projects/active/daily_use/project-manager/backend/node_modules/@jest/console/build/index.js:288:48)
        at ActivityLogger.log (/home/lucas/projects/active/daily_use/project-manager/backend/src/services/activityLogger.ts:149:15)
        at processTicksAndRejections (node:internal/process/task_queues:105:5)
        at Object.<anonymous> (/home/lucas/projects/active/daily_use/project-manager/backend/src/tests/services/activityLogger.test.ts:90:9) {
      errors: {
        action: ValidatorError: `action_0` is not a valid enum value for path `action`.
            at validate (/home/lucas/projects/active/daily_use/project-manager/backend/node_modules/mongoose/lib/schematype.js:1365:13)
            at SchemaString.SchemaType.doValidate (/home/lucas/projects/active/daily_use/project-manager/backend/node_modules/mongoose/lib/schematype.js:1349:7)
            at /home/lucas/projects/active/daily_use/project-manager/backend/node_modules/mongoose/lib/document.js:3004:18
            at processTicksAndRejections (node:internal/process/task_queues:85:11) {
          properties: [Object],
          kind: 'enum',
          path: 'action',
          value: 'action_0',
          reason: undefined,
          [Symbol(mongoose:validatorError)]: true
        }
      },
      _message: 'ActivityLog validation failed'
    }

      147 |       return await activityLog.save();
      148 |     } catch (error) {
    > 149 |       console.error('Failed to log activity:', error);
          |               ^
      150 |       throw error;
      151 |     }
      152 |   }

      at ActivityLogger.log (src/services/activityLogger.ts:149:15)
      at Object.<anonymous> (src/tests/services/activityLogger.test.ts:90:9)

  console.error
    Failed to log activity: Error: ActivityLog validation failed: action: `user_action_0` is not a valid enum value for path `action`.
        at ValidationError.inspect (/home/lucas/projects/active/daily_use/project-manager/backend/node_modules/mongoose/lib/error/validation.js:50:26)
        at formatValue (node:internal/util/inspect:877:19)
        at inspect (node:internal/util/inspect:404:10)
        at formatWithOptionsInternal (node:internal/util/inspect:2402:40)
        at format (node:internal/util/inspect:2259:10)
        at console.error (/home/lucas/projects/active/daily_use/project-manager/backend/node_modules/@jest/console/build/index.js:288:48)
        at ActivityLogger.log (/home/lucas/projects/active/daily_use/project-manager/backend/src/services/activityLogger.ts:149:15)
        at processTicksAndRejections (node:internal/process/task_queues:105:5)
        at Object.<anonymous> (/home/lucas/projects/active/daily_use/project-manager/backend/src/tests/services/activityLogger.test.ts:177:9) {
      errors: {
        action: ValidatorError: `user_action_0` is not a valid enum value for path `action`.
            at validate (/home/lucas/projects/active/daily_use/project-manager/backend/node_modules/mongoose/lib/schematype.js:1365:13)
            at SchemaString.SchemaType.doValidate (/home/lucas/projects/active/daily_use/project-manager/backend/node_modules/mongoose/lib/schematype.js:1349:7)
            at /home/lucas/projects/active/daily_use/project-manager/backend/node_modules/mongoose/lib/document.js:3004:18
            at processTicksAndRejections (node:internal/process/task_queues:85:11) {
          properties: [Object],
          kind: 'enum',
          path: 'action',
          value: 'user_action_0',
          reason: undefined,
          [Symbol(mongoose:validatorError)]: true
        }
      },
      _message: 'ActivityLog validation failed'
    }

      147 |       return await activityLog.save();
      148 |     } catch (error) {
    > 149 |       console.error('Failed to log activity:', error);
          |               ^
      150 |       throw error;
      151 |     }
      152 |   }

      at ActivityLogger.log (src/services/activityLogger.ts:149:15)
      at Object.<anonymous> (src/tests/services/activityLogger.test.ts:177:9)

  console.error
    Failed to log activity: Error: ActivityLog validation failed: action: `user_action_0` is not a valid enum value for path `action`.
        at ValidationError.inspect (/home/lucas/projects/active/daily_use/project-manager/backend/node_modules/mongoose/lib/error/validation.js:50:26)
        at formatValue (node:internal/util/inspect:877:19)
        at inspect (node:internal/util/inspect:404:10)
        at formatWithOptionsInternal (node:internal/util/inspect:2402:40)
        at format (node:internal/util/inspect:2259:10)
        at console.error (/home/lucas/projects/active/daily_use/project-manager/backend/node_modules/@jest/console/build/index.js:288:48)
        at ActivityLogger.log (/home/lucas/projects/active/daily_use/project-manager/backend/src/services/activityLogger.ts:149:15)
        at processTicksAndRejections (node:internal/process/task_queues:105:5)
        at Object.<anonymous> (/home/lucas/projects/active/daily_use/project-manager/backend/src/tests/services/activityLogger.test.ts:177:9) {
      errors: {
        action: ValidatorError: `user_action_0` is not a valid enum value for path `action`.
            at validate (/home/lucas/projects/active/daily_use/project-manager/backend/node_modules/mongoose/lib/schematype.js:1365:13)
            at SchemaString.SchemaType.doValidate (/home/lucas/projects/active/daily_use/project-manager/backend/node_modules/mongoose/lib/schematype.js:1349:7)
            at /home/lucas/projects/active/daily_use/project-manager/backend/node_modules/mongoose/lib/document.js:3004:18
            at processTicksAndRejections (node:internal/process/task_queues:85:11) {
          properties: [Object],
          kind: 'enum',
          path: 'action',
          value: 'user_action_0',
          reason: undefined,
          [Symbol(mongoose:validatorError)]: true
        }
      },
      _message: 'ActivityLog validation failed'
    }

      147 |       return await activityLog.save();
      148 |     } catch (error) {
    > 149 |       console.error('Failed to log activity:', error);
          |               ^
      150 |       throw error;
      151 |     }
      152 |   }

      at ActivityLogger.log (src/services/activityLogger.ts:149:15)
      at Object.<anonymous> (src/tests/services/activityLogger.test.ts:177:9)

  console.error
    Failed to log activity: Error: ActivityLog validation failed: action: `recent_action` is not a valid enum value for path `action`.
        at ValidationError.inspect (/home/lucas/projects/active/daily_use/project-manager/backend/node_modules/mongoose/lib/error/validation.js:50:26)
        at formatValue (node:internal/util/inspect:877:19)
        at inspect (node:internal/util/inspect:404:10)
        at formatWithOptionsInternal (node:internal/util/inspect:2402:40)
        at format (node:internal/util/inspect:2259:10)
        at console.error (/home/lucas/projects/active/daily_use/project-manager/backend/node_modules/@jest/console/build/index.js:288:48)
        at ActivityLogger.log (/home/lucas/projects/active/daily_use/project-manager/backend/src/services/activityLogger.ts:149:15)
        at processTicksAndRejections (node:internal/process/task_queues:105:5)
        at Object.<anonymous> (/home/lucas/projects/active/daily_use/project-manager/backend/src/tests/services/activityLogger.test.ts:212:7) {
      errors: {
        action: ValidatorError: `recent_action` is not a valid enum value for path `action`.
            at validate (/home/lucas/projects/active/daily_use/project-manager/backend/node_modules/mongoose/lib/schematype.js:1365:13)
            at SchemaString.SchemaType.doValidate (/home/lucas/projects/active/daily_use/project-manager/backend/node_modules/mongoose/lib/schematype.js:1349:7)
            at /home/lucas/projects/active/daily_use/project-manager/backend/node_modules/mongoose/lib/document.js:3004:18
            at processTicksAndRejections (node:internal/process/task_queues:85:11) {
          properties: [Object],
          kind: 'enum',
          path: 'action',
          value: 'recent_action',
          reason: undefined,
          [Symbol(mongoose:validatorError)]: true
        }
      },
      _message: 'ActivityLog validation failed'
    }

      147 |       return await activityLog.save();
      148 |     } catch (error) {
    > 149 |       console.error('Failed to log activity:', error);
          |               ^
      150 |       throw error;
      151 |     }
      152 |   }

      at ActivityLogger.log (src/services/activityLogger.ts:149:15)
      at Object.<anonymous> (src/tests/services/activityLogger.test.ts:212:7)

FAIL src/tests/services/activityLogger.test.ts
  ActivityLogger Service
    log
      ‚úì should create activity log entry (387 ms)
      ‚úï should include metadata (331 ms)
      ‚úì should include user agent and IP (290 ms)
    getProjectActivities
      ‚úï should get activities for a project (291 ms)
      ‚úï should support pagination (291 ms)
      ‚úï should filter by user (294 ms)
      ‚úï should filter by date range (307 ms)
    getUserActivities
      ‚úï should get activities for a user (302 ms)
      ‚úï should filter by project (298 ms)
    getRecentActivity
      ‚úï should get recent activity (285 ms)
      ‚úì should only return activities within time window (288 ms)
    logProjectJoin
      ‚úì should log project join (297 ms)
      ‚úì should prevent duplicate joins within time window (298 ms)

  ‚óè ActivityLogger Service ‚Ä∫ log ‚Ä∫ should include metadata

    ValidationError: ActivityLog validation failed: action: `todo_created` is not a valid enum value for path `action`.

      at model.Document.invalidate (node_modules/mongoose/lib/document.js:3219:32)
      at node_modules/mongoose/lib/document.js:3012:17
      at node_modules/mongoose/lib/schematype.js:1368:9

  ‚óè ActivityLogger Service ‚Ä∫ getProjectActivities ‚Ä∫ should get activities for a project

    ValidationError: ActivityLog validation failed: action: `action_0` is not a valid enum value for path `action`.

      at model.Document.invalidate (node_modules/mongoose/lib/document.js:3219:32)
      at node_modules/mongoose/lib/document.js:3012:17
      at node_modules/mongoose/lib/schematype.js:1368:9

  ‚óè ActivityLogger Service ‚Ä∫ getProjectActivities ‚Ä∫ should support pagination

    ValidationError: ActivityLog validation failed: action: `action_0` is not a valid enum value for path `action`.

      at model.Document.invalidate (node_modules/mongoose/lib/document.js:3219:32)
      at node_modules/mongoose/lib/document.js:3012:17
      at node_modules/mongoose/lib/schematype.js:1368:9

  ‚óè ActivityLogger Service ‚Ä∫ getProjectActivities ‚Ä∫ should filter by user

    ValidationError: ActivityLog validation failed: action: `action_0` is not a valid enum value for path `action`.

      at model.Document.invalidate (node_modules/mongoose/lib/document.js:3219:32)
      at node_modules/mongoose/lib/document.js:3012:17
      at node_modules/mongoose/lib/schematype.js:1368:9

  ‚óè ActivityLogger Service ‚Ä∫ getProjectActivities ‚Ä∫ should filter by date range

    ValidationError: ActivityLog validation failed: action: `action_0` is not a valid enum value for path `action`.

      at model.Document.invalidate (node_modules/mongoose/lib/document.js:3219:32)
      at node_modules/mongoose/lib/document.js:3012:17
      at node_modules/mongoose/lib/schematype.js:1368:9

  ‚óè ActivityLogger Service ‚Ä∫ getUserActivities ‚Ä∫ should get activities for a user

    ValidationError: ActivityLog validation failed: action: `user_action_0` is not a valid enum value for path `action`.

      at model.Document.invalidate (node_modules/mongoose/lib/document.js:3219:32)
      at node_modules/mongoose/lib/document.js:3012:17
      at node_modules/mongoose/lib/schematype.js:1368:9

  ‚óè ActivityLogger Service ‚Ä∫ getUserActivities ‚Ä∫ should filter by project

    ValidationError: ActivityLog validation failed: action: `user_action_0` is not a valid enum value for path `action`.

      at model.Document.invalidate (node_modules/mongoose/lib/document.js:3219:32)
      at node_modules/mongoose/lib/document.js:3012:17
      at node_modules/mongoose/lib/schematype.js:1368:9

  ‚óè ActivityLogger Service ‚Ä∫ getRecentActivity ‚Ä∫ should get recent activity

    ValidationError: ActivityLog validation failed: action: `recent_action` is not a valid enum value for path `action`.

      at model.Document.invalidate (node_modules/mongoose/lib/document.js:3219:32)
      at node_modules/mongoose/lib/document.js:3012:17
      at node_modules/mongoose/lib/schematype.js:1368:9

FAIL src/tests/public.test.ts
  Public Routes
    GET /api/public/project/:identifier
      ‚úì should get public project by ID (418 ms)
      ‚úì should get public project by slug (302 ms)
      ‚úì should return 404 for non-existent project (13 ms)
      ‚úì should return 403 for private project (287 ms)
      ‚úì should respect visibility settings (301 ms)
      ‚úì should include owner information (299 ms)
      ‚úì should not expose sensitive project data (296 ms)
    GET /api/public/user/:identifier
      ‚úï should get public user profile (286 ms)
      ‚úì should return 403 for private user profile (286 ms)
      ‚úì should not expose sensitive user data (297 ms)
    GET /api/public/user/:identifier/projects
      ‚úï should get public projects for user (298 ms)

  ‚óè Public Routes ‚Ä∫ GET /api/public/user/:identifier ‚Ä∫ should get public user profile

    expected 200 "OK", got 404 "Not Found"

      199 |       const response = await request(app)
      200 |         .get('/api/public/user/profile-user')
    > 201 |         .expect(200);
          |          ^
      202 |
      203 |       expect(response.body).toHaveProperty('success', true);
      204 |       expect(response.body.user).toHaveProperty('username', 'profileuser');

      at Object.<anonymous> (src/tests/public.test.ts:201:10)
      ----
      at Test._assertStatus (node_modules/supertest/lib/test.js:309:14)
      at node_modules/supertest/lib/test.js:365:13
      at Test._assertFunction (node_modules/supertest/lib/test.js:342:13)
      at Test.assert (node_modules/supertest/lib/test.js:195:23)
      at localAssert (node_modules/supertest/lib/test.js:138:14)
      at Server.<anonymous> (node_modules/supertest/lib/test.js:152:11)

  ‚óè Public Routes ‚Ä∫ GET /api/public/user/:identifier/projects ‚Ä∫ should get public projects for user

    expected 200 "OK", got 404 "Not Found"

      276 |       const response = await request(app)
      277 |         .get('/api/public/user/projects-user/projects')
    > 278 |         .expect(200);
          |          ^
      279 |
      280 |       expect(response.body).toHaveProperty('projects');
      281 |       expect(Array.isArray(response.body.projects)).toBe(true);

      at Object.<anonymous> (src/tests/public.test.ts:278:10)
      ----
      at Test._assertStatus (node_modules/supertest/lib/test.js:309:14)
      at node_modules/supertest/lib/test.js:365:13
      at Test._assertFunction (node_modules/supertest/lib/test.js:342:13)
      at Test.assert (node_modules/supertest/lib/test.js:195:23)
      at localAssert (node_modules/supertest/lib/test.js:138:14)
      at Server.<anonymous> (node_modules/supertest/lib/test.js:152:11)

FAIL src/tests/handlers/StackHandlers.test.ts
  StackHandlers
    handleAddStack
      ‚úì should trigger wizard when no args or flags (79 ms)
      ‚úì should add stack item with all fields (126 ms)
      ‚úì should reject old args syntax (34 ms)
      ‚úì should validate required name field (23 ms)
      ‚úï should add stack item with minimal fields (34 ms)
    handleViewStack
      ‚úì should view all stack items (26 ms)
      ‚úï should filter by category (37 ms)
    handleRemoveStack
      ‚úï should remove stack item (12 ms)
      ‚úì should error when removing non-existent item (8 ms)

  ‚óè StackHandlers ‚Ä∫ handleAddStack ‚Ä∫ should add stack item with minimal fields

    expect(received).toBe(expected) // Object.is equality

    Expected: "Express"
    Received: "Express.js"

      142 |
      143 |       expect(result.type).toBe(ResponseType.SUCCESS);
    > 144 |       expect(mockProject.stack[0].name).toBe('Express');
          |                                         ^
      145 |     });
      146 |   });
      147 |

      at Object.<anonymous> (src/tests/handlers/StackHandlers.test.ts:144:41)

  ‚óè StackHandlers ‚Ä∫ handleViewStack ‚Ä∫ should filter by category

    expect(received).toHaveLength(expected)

    Expected length: 1
    Received length: 3
    Received array:  [{"category": "framework", "description": "", "name": "React", "version": "18.2.0"}, {"category": "api", "description": "", "name": "Express", "version": "4.18.0"}, {"category": "database", "description": "", "name": "MongoDB", "version": "6.0"}]

      192 |
      193 |       expect(result.type).toBe(ResponseType.DATA);
    > 194 |       expect(result.data.stack).toHaveLength(1);
          |                                 ^
      195 |       expect(result.data.stack[0].name).toBe('React');
      196 |     });
      197 |   });

      at Object.<anonymous> (src/tests/handlers/StackHandlers.test.ts:194:33)

  ‚óè StackHandlers ‚Ä∫ handleRemoveStack ‚Ä∫ should remove stack item

    expect(received).toBe(expected) // Object.is equality

    Expected: "success"
    Received: "error"

      221 |       const result = await handler.handleRemoveStack(parsed, projectId);
      222 |
    > 223 |       expect(result.type).toBe(ResponseType.SUCCESS);
          |                           ^
      224 |       expect(mockProject.stack).toHaveLength(1);
      225 |       expect(mockProject.stack[0].id).toBe('2');
      226 |       expect(mockProject.save).toHaveBeenCalled();

      at Object.<anonymous> (src/tests/handlers/StackHandlers.test.ts:223:27)

FAIL src/tests/integration-project-lifecycle.test.ts
  Integration: Project Lifecycle
    ‚úï should handle full project CRUD workflow (989 ms)

  ‚óè Integration: Project Lifecycle ‚Ä∫ should handle full project CRUD workflow

    expect(received).toBe(expected) // Object.is equality

    Expected: 200
    Received: 403

      79 |       .set('Cookie', userCookie);
      80 |
    > 81 |     expect(deleteRes.status).toBe(200);
         |                              ^
      82 |   });
      83 | });
      84 |

      at Object.<anonymous> (src/tests/integration-project-lifecycle.test.ts:81:30)

FAIL src/tests/integration-billing.test.ts
  Integration: Billing & Subscription Limits
    ‚úì should enforce project limits for free tier users (991 ms)
    ‚úï should allow more projects after upgrading plan (57 ms)

  ‚óè Integration: Billing & Subscription Limits ‚Ä∫ should allow more projects after upgrading plan

    expect(received).toBeTruthy()

    Received: null

      85 |     // Upgrade to pro
      86 |     const dbUser = await User.findOne({ email: user.email });
    > 87 |     expect(dbUser).toBeTruthy();
         |                    ^
      88 |     
      89 |     dbUser!.planTier = 'pro';
      90 |     dbUser!.projectLimit = 10;

      at Object.<anonymous> (src/tests/integration-billing.test.ts:87:20)

FAIL src/tests/integration-team-collaboration.test.ts
  Integration: Team Collaboration
    ‚úï should handle team invitation workflow (290 ms)

  ‚óè Integration: Team Collaboration ‚Ä∫ should handle team invitation workflow

    TypeError: Invalid value "undefined" for header "Cookie"

      at Test.setHeader [as request] (node_modules/superagent/src/node/index.js:830:39)
      at Test.request [as end] (node_modules/superagent/src/node/index.js:965:8)
      at Test.end (node_modules/supertest/lib/test.js:136:11)
      at end (node_modules/superagent/src/request-base.js:283:12)
      at Test.RequestBase.then (node_modules/superagent/src/request-base.js:265:31)

FAIL src/tests/middleware-auth.test.ts
  Auth Middleware
    requireAuth
      ‚úï should authenticate valid token (3 ms)
      ‚úì should reject missing token (2 ms)
      ‚úì should reject invalid token (1 ms)
      ‚úï should handle expired token (3 ms)
      ‚úï should handle missing JWT_SECRET (2 ms)
      ‚úì should handle malformed token (1 ms)
    requireProjectAccess
      ‚úï should grant access to project owner (2 ms)
      ‚úï should grant access to team member with editor role (2 ms)
      ‚úï should grant limited access to team member with viewer role (3 ms)
      ‚úï should deny access if project not found (2 ms)
      ‚úï should deny access if user has no permissions (2 ms)
      ‚úï should deny access for edit permission when user only has view access (1 ms)
      ‚úï should handle database errors (2 ms)
      ‚úï should require authentication first (2 ms)
      ‚úï should require project ID in params (1 ms)
      ‚úï should allow team management for owner role (2 ms)

  ‚óè Auth Middleware ‚Ä∫ requireAuth ‚Ä∫ should authenticate valid token

    expect(jest.fn()).toHaveBeenCalledWith(...expected)

    Expected: "valid-token", "test-secret"

    Number of calls: 0

      57 |       requireAuth(mockReq as AuthRequest, mockRes as Response, mockNext);
      58 |
    > 59 |       expect(jwt.verify).toHaveBeenCalledWith('valid-token', 'test-secret');
         |                          ^
      60 |       expect(mockReq.userId).toBe(mockUserId);
      61 |       expect(mockNext).toHaveBeenCalled();
      62 |     });

      at Object.<anonymous> (src/tests/middleware-auth.test.ts:59:26)

  ‚óè Auth Middleware ‚Ä∫ requireAuth ‚Ä∫ should handle expired token

    expect(jest.fn()).toHaveBeenCalledWith(...expected)

    - Expected
    + Received

      Object {
    -   "message": "Token expired",
    +   "message": "Invalid token",
      },

    Number of calls: 1

       98 |
       99 |       expect(mockRes.status).toHaveBeenCalledWith(401);
    > 100 |       expect(mockRes.json).toHaveBeenCalledWith({ message: 'Token expired' });
          |                            ^
      101 |       expect(mockNext).not.toHaveBeenCalled();
      102 |     });
      103 |

      at Object.<anonymous> (src/tests/middleware-auth.test.ts:100:28)

  ‚óè Auth Middleware ‚Ä∫ requireAuth ‚Ä∫ should handle missing JWT_SECRET

    expect(jest.fn()).toHaveBeenCalledWith(...expected)

    Expected: 500
    Received: 401

    Number of calls: 1

      108 |       requireAuth(mockReq as AuthRequest, mockRes as Response, mockNext);
      109 |
    > 110 |       expect(mockRes.status).toHaveBeenCalledWith(500);
          |                              ^
      111 |       expect(mockRes.json).toHaveBeenCalledWith({ message: 'Server configuration error' });
      112 |       expect(mockNext).not.toHaveBeenCalled();
      113 |     });

      at Object.<anonymous> (src/tests/middleware-auth.test.ts:110:30)

  ‚óè Auth Middleware ‚Ä∫ requireProjectAccess ‚Ä∫ should grant access to project owner

    expect(received).toEqual(expected) // deep equality

    Expected: {"canEdit": true, "canManageTeam": true, "isOwner": true, "role": "owner"}
    Received: undefined

      149 |       await middleware(mockReq as AuthRequest, mockRes as Response, mockNext);
      150 |
    > 151 |       expect(mockReq.projectAccess).toEqual({
          |                                     ^
      152 |         isOwner: true,
      153 |         role: 'owner',
      154 |         canEdit: true,

      at Object.<anonymous> (src/tests/middleware-auth.test.ts:151:37)

  ‚óè Auth Middleware ‚Ä∫ requireProjectAccess ‚Ä∫ should grant access to team member with editor role

    expect(received).toEqual(expected) // deep equality

    Expected: {"canEdit": true, "canManageTeam": false, "isOwner": false, "role": "editor"}
    Received: undefined

      177 |       await middleware(mockReq as AuthRequest, mockRes as Response, mockNext);
      178 |
    > 179 |       expect(mockReq.projectAccess).toEqual({
          |                                     ^
      180 |         isOwner: false,
      181 |         role: 'editor',
      182 |         canEdit: true,

      at Object.<anonymous> (src/tests/middleware-auth.test.ts:179:37)

  ‚óè Auth Middleware ‚Ä∫ requireProjectAccess ‚Ä∫ should grant limited access to team member with viewer role

    expect(received).toEqual(expected) // deep equality

    Expected: {"canEdit": false, "canManageTeam": false, "isOwner": false, "role": "viewer"}
    Received: undefined

      205 |       await middleware(mockReq as AuthRequest, mockRes as Response, mockNext);
      206 |
    > 207 |       expect(mockReq.projectAccess).toEqual({
          |                                     ^
      208 |         isOwner: false,
      209 |         role: 'viewer',
      210 |         canEdit: false,

      at Object.<anonymous> (src/tests/middleware-auth.test.ts:207:37)

  ‚óè Auth Middleware ‚Ä∫ requireProjectAccess ‚Ä∫ should deny access if project not found

    expect(jest.fn()).toHaveBeenCalledWith(...expected)

    Expected: 404

    Number of calls: 0

      220 |       await middleware(mockReq as AuthRequest, mockRes as Response, mockNext);
      221 |
    > 222 |       expect(mockRes.status).toHaveBeenCalledWith(404);
          |                              ^
      223 |       expect(mockRes.json).toHaveBeenCalledWith({ message: 'Project not found' });
      224 |       expect(mockNext).not.toHaveBeenCalled();
      225 |     });

      at Object.<anonymous> (src/tests/middleware-auth.test.ts:222:30)

  ‚óè Auth Middleware ‚Ä∫ requireProjectAccess ‚Ä∫ should deny access if user has no permissions

    expect(jest.fn()).toHaveBeenCalledWith(...expected)

    Expected: 403

    Number of calls: 0

      237 |       await middleware(mockReq as AuthRequest, mockRes as Response, mockNext);
      238 |
    > 239 |       expect(mockRes.status).toHaveBeenCalledWith(403);
          |                              ^
      240 |       expect(mockRes.json).toHaveBeenCalledWith({ message: 'Access denied: Not a team member' });
      241 |       expect(mockNext).not.toHaveBeenCalled();
      242 |     });

      at Object.<anonymous> (src/tests/middleware-auth.test.ts:239:30)

  ‚óè Auth Middleware ‚Ä∫ requireProjectAccess ‚Ä∫ should deny access for edit permission when user only has view access

    expect(jest.fn()).toHaveBeenCalledWith(...expected)

    Expected: 403

    Number of calls: 0

      260 |       await middleware(mockReq as AuthRequest, mockRes as Response, mockNext);
      261 |
    > 262 |       expect(mockRes.status).toHaveBeenCalledWith(403);
          |                              ^
      263 |       expect(mockRes.json).toHaveBeenCalledWith({ message: 'Access denied: Edit permission required' });
      264 |       expect(mockNext).not.toHaveBeenCalled();
      265 |     });

      at Object.<anonymous> (src/tests/middleware-auth.test.ts:262:30)

  ‚óè Auth Middleware ‚Ä∫ requireProjectAccess ‚Ä∫ should handle database errors

    expect(jest.fn()).toHaveBeenCalledWith(...expected)

    Expected: 500

    Number of calls: 0

      271 |       await middleware(mockReq as AuthRequest, mockRes as Response, mockNext);
      272 |
    > 273 |       expect(mockRes.status).toHaveBeenCalledWith(500);
          |                              ^
      274 |       expect(mockRes.json).toHaveBeenCalledWith({ message: 'Server error checking project access' });
      275 |       expect(mockNext).not.toHaveBeenCalled();
      276 |     });

      at Object.<anonymous> (src/tests/middleware-auth.test.ts:273:30)

  ‚óè Auth Middleware ‚Ä∫ requireProjectAccess ‚Ä∫ should require authentication first

    expect(jest.fn()).toHaveBeenCalledWith(...expected)

    - Expected
    + Received

      Object {
    -   "message": "Missing authentication or project ID",
    +   "message": "Not authenticated",
      },

    Number of calls: 1

      283 |
      284 |       expect(mockRes.status).toHaveBeenCalledWith(401);
    > 285 |       expect(mockRes.json).toHaveBeenCalledWith({ message: 'Missing authentication or project ID' });
          |                            ^
      286 |       expect(mockNext).not.toHaveBeenCalled();
      287 |     });
      288 |

      at Object.<anonymous> (src/tests/middleware-auth.test.ts:285:28)

  ‚óè Auth Middleware ‚Ä∫ requireProjectAccess ‚Ä∫ should require project ID in params

    expect(jest.fn()).toHaveBeenCalledWith(...expected)

    Expected: 401

    Number of calls: 0

      293 |       await middleware(mockReq as AuthRequest, mockRes as Response, mockNext);
      294 |
    > 295 |       expect(mockRes.status).toHaveBeenCalledWith(401);
          |                              ^
      296 |       expect(mockRes.json).toHaveBeenCalledWith({ message: 'Missing authentication or project ID' });
      297 |       expect(mockNext).not.toHaveBeenCalled();
      298 |     });

      at Object.<anonymous> (src/tests/middleware-auth.test.ts:295:30)

  ‚óè Auth Middleware ‚Ä∫ requireProjectAccess ‚Ä∫ should allow team management for owner role

    expect(received).toEqual(expected) // deep equality

    Expected: {"canEdit": true, "canManageTeam": true, "isOwner": false, "role": "owner"}
    Received: undefined

      316 |       await middleware(mockReq as AuthRequest, mockRes as Response, mockNext);
      317 |
    > 318 |       expect(mockReq.projectAccess).toEqual({
          |                                     ^
      319 |         isOwner: false,
      320 |         role: 'owner',
      321 |         canEdit: true,

      at Object.<anonymous> (src/tests/middleware-auth.test.ts:318:37)

FAIL src/tests/handlers/SettingsHandlers.test.ts
  SettingsHandlers
    handleViewSettings
      ‚úì should view project settings (14 ms)
    handleSetName
      ‚úì should set project name (5 ms)
      ‚úï should validate empty name (7 ms)
    handleSetDescription
      ‚úì should set project description (9 ms)
      ‚úì should validate empty description (4 ms)
    handleAddTag
      ‚úì should add a new tag (2 ms)
      ‚úì should prevent duplicate tags (3 ms)
      ‚úì should validate empty tag (3 ms)
    handleRemoveTag
      ‚úì should remove an existing tag (4 ms)
      ‚úì should error when removing non-existent tag (5 ms)
    handleSetPublic
      ‚úï should set project to public (3 ms)
      ‚úï should set project to private (3 ms)

  ‚óè SettingsHandlers ‚Ä∫ handleSetName ‚Ä∫ should validate empty name

    expect(received).toContain(expected) // indexOf

    Expected substring: "valid"
    Received string:    "Project name cannot be empty"

       96 |
       97 |       expect(result.type).toBe(ResponseType.ERROR);
    >  98 |       expect(result.message).toContain('valid');
          |                              ^
       99 |     });
      100 |   });
      101 |

      at Object.<anonymous> (src/tests/handlers/SettingsHandlers.test.ts:98:30)

  ‚óè SettingsHandlers ‚Ä∫ handleSetPublic ‚Ä∫ should set project to public

    expect(received).toBe(expected) // Object.is equality

    Expected: "success"
    Received: "error"

      266 |       const result = await handler.handleSetPublic(parsed, projectId);
      267 |
    > 268 |       expect(result.type).toBe(ResponseType.SUCCESS);
          |                           ^
      269 |       expect(mockProject.isPublic).toBe(true);
      270 |       expect(mockProject.save).toHaveBeenCalled();
      271 |     });

      at Object.<anonymous> (src/tests/handlers/SettingsHandlers.test.ts:268:27)

  ‚óè SettingsHandlers ‚Ä∫ handleSetPublic ‚Ä∫ should set project to private

    expect(received).toBe(expected) // Object.is equality

    Expected: "success"
    Received: "error"

      288 |       const result = await handler.handleSetPublic(parsed, projectId);
      289 |
    > 290 |       expect(result.type).toBe(ResponseType.SUCCESS);
          |                           ^
      291 |       expect(mockProject.isPublic).toBe(false);
      292 |       expect(mockProject.save).toHaveBeenCalled();
      293 |     });

      at Object.<anonymous> (src/tests/handlers/SettingsHandlers.test.ts:290:27)

FAIL src/tests/services/emailService.test.ts
  emailService
    sendProjectInvitationEmail
      ‚úï should send invitation email with correct details (4 ms)
      ‚úì should include invitation URL in email (2 ms)
      ‚úì should include project name and inviter name (2 ms)
      ‚úì should not send email if SMTP credentials are missing (2 ms)

  ‚óè emailService ‚Ä∫ sendProjectInvitationEmail ‚Ä∫ should send invitation email with correct details

    expect(jest.fn()).toHaveBeenCalledWith(...expected)

    Expected: ObjectContaining {"subject": StringContaining "invitation", "to": "invitee@example.com"}
    Received: {"from": "\"Project Manager\" <test@example.com>", "html": "
        <!DOCTYPE html>
        <html>
        <head>
          <meta charset=\"utf-8\">
          <title>Project Invitation</title>
          <style>
            body {
              font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
              line-height: 1.6;
              color: #333;
              max-width: 600px;
              margin: 0 auto;
              padding: 20px;
            }
            .header {
              text-align: center;
              padding: 30px 0;
              border-bottom: 2px solid #3B82F6;
            }
            .content {
              padding: 30px 0;
            }
            .cta-button {
              display: inline-block;
              background-color: #3B82F6;
              color: white;
              padding: 12px 30px;
              text-decoration: none;
              border-radius: 6px;
              font-weight: 600;
              margin: 20px 0;
            }
            .cta-button:hover {
              background-color: #2563EB;
            }
            .footer {
              margin-top: 40px;
              padding-top: 20px;
              border-top: 1px solid #e5e7eb;
              font-size: 14px;
              color: #6b7280;
            }
            .project-info {
              background-color: #f8fafc;
              padding: 20px;
              border-radius: 8px;
              margin: 20px 0;
            }
          </style>
        </head>
        <body>
          <div class=\"header\">
            <h1>üéØ Project Manager</h1>
            <h2>You're invited to collaborate!</h2>
          </div>¬∑¬∑¬∑¬∑¬∑¬∑¬∑
          <div class=\"content\">
            <p>Hi there!</p>¬∑¬∑¬∑¬∑¬∑¬∑¬∑¬∑¬∑
            <p><strong>John Doe</strong> has invited you to collaborate on their project as a <strong>editor</strong>.</p>¬∑¬∑¬∑¬∑¬∑¬∑¬∑¬∑¬∑
            <div class=\"project-info\">
              <h3>üìã Project: Test Project</h3>
              <p><strong>Your role:</strong> Editor</p>
            </div>¬∑¬∑¬∑¬∑¬∑¬∑¬∑¬∑¬∑
            <p>Click the button below to accept the invitation and start collaborating:</p>¬∑¬∑¬∑¬∑¬∑¬∑¬∑¬∑¬∑
            <div style=\"text-align: center;\">
              <a href=\"http://localhost:5002/invitation/test-token-123\" class=\"cta-button\">Accept Invitation</a>
            </div>¬∑¬∑¬∑¬∑¬∑¬∑¬∑¬∑¬∑
            <p>Or copy and paste this link into your browser:</p>
            <p><a href=\"http://localhost:5002/invitation/test-token-123\">http://localhost:5002/invitation/test-token-123</a></p>¬∑¬∑¬∑¬∑¬∑¬∑¬∑¬∑¬∑
            <p>This invitation will expire in 7 days. If you don't have an account yet, you'll be able to create one during the acceptance process.</p>
          </div>¬∑¬∑¬∑¬∑¬∑¬∑¬∑
          <div class=\"footer\">
            <p>This invitation was sent by John Doe through Project Manager.</p>
            <p>If you weren't expecting this invitation, you can safely ignore this email.</p>
          </div>
        </body>
        </html>
      ", "subject": "You're invited to collaborate on \"Test Project\"", "text": "
    Project Manager - Collaboration Invitation¬∑
    Hi there!¬∑
    John Doe has invited you to collaborate on their project \"Test Project\" as a editor.¬∑
    Accept your invitation by visiting this link:
    http://localhost:5002/invitation/test-token-123¬∑
    This invitation will expire in 7 days. If you don't have an account yet, you'll be able to create one during the acceptance process.¬∑
    If you weren't expecting this invitation, you can safely ignore this email.¬∑
    ---
    Project Manager Team
      ", "to": "invitee@example.com"}

    Number of calls: 1

      37 |
      38 |       expect(nodemailer.createTransport).toHaveBeenCalled();
    > 39 |       expect(mockSendMail).toHaveBeenCalledWith(
         |                            ^
      40 |         expect.objectContaining({
      41 |           to: 'invitee@example.com',
      42 |           subject: expect.stringContaining('invitation')

      at Object.<anonymous> (src/tests/services/emailService.test.ts:39:28)

  console.log
    Password reset attempted for non-existent email: nonexistent@example.com

      at src/routes/auth.ts:795:15

PASS src/tests/auth.test.ts (27.25 s)
  Authentication Routes
    POST /api/auth/register
      ‚úì should register a new user with valid data (489 ms)
      ‚úì should reject registration with weak password (29 ms)
      ‚úì should reject registration with invalid email (24 ms)
      ‚úì should reject registration with missing required fields (27 ms)
      ‚úì should reject registration with duplicate email (326 ms)
    POST /api/auth/login
      ‚úì should login with valid credentials (573 ms)
      ‚úì should reject login with invalid email (297 ms)
      ‚úì should reject login with invalid password (562 ms)
      ‚úì should reject login with missing credentials (304 ms)
    POST /api/auth/logout
      ‚úì should logout successfully (21 ms)
    GET /api/auth/me
      ‚úì should return user data for authenticated user (588 ms)
      ‚úì should reject request without authentication (590 ms)
      ‚úì should reject request with invalid token (607 ms)
    GET /api/auth/check-username/:username
      ‚úì should return available for new username (291 ms)
      ‚úì should return unavailable for existing username (294 ms)
      ‚úì should reject username with invalid characters (305 ms)
      ‚úì should reject username that is too short (328 ms)
      ‚úì should reject username that is too long (307 ms)
    PATCH /api/auth/theme
      ‚úì should update theme successfully (602 ms)
      ‚úì should accept custom themes (599 ms)
      ‚úì should reject invalid theme (577 ms)
      ‚úì should require authentication (584 ms)
    PATCH /api/auth/update-name
      ‚úì should update name successfully (626 ms)
      ‚úì should trim whitespace from names (658 ms)
      ‚úì should reject missing first name (608 ms)
      ‚úì should reject missing last name (586 ms)
      ‚úì should require authentication (582 ms)
    PATCH /api/auth/update-username
      ‚úì should update username successfully (929 ms)
      ‚úì should convert username to lowercase (871 ms)
      ‚úì should reject taken username (850 ms)
      ‚úì should reject username with invalid characters (965 ms)
      ‚úì should reject username that is too short (890 ms)
      ‚úì should reject missing username (889 ms)
      ‚úì should require authentication (875 ms)
    PATCH /api/auth/profile
      ‚úì should update bio successfully (579 ms)
      ‚úì should update public profile settings (607 ms)
      ‚úì should update display preference to username (599 ms)
      ‚úì should update display preference to name (623 ms)
      ‚úì should reject invalid display preference (575 ms)
      ‚úì should require authentication (570 ms)
    Password Reset Flow
      ‚úì should handle forgot password request for existing email (1905 ms)
      ‚úì should not reveal if email does not exist (29 ms)
      ‚úì should reject password reset with invalid email format (26 ms)
      ‚úì should reject password reset without email (26 ms)
    POST /api/auth/custom-themes
      ‚úì should save custom themes (590 ms)
      ‚úì should require authentication (593 ms)
    GET /api/auth/custom-themes
      ‚úì should get custom themes (657 ms)
      ‚úì should return empty array if no custom themes (1175 ms)
      ‚úì should require authentication (620 ms)

2025-11-11 15:36:23 [[31MERROR[39M]: Get single project error | {"service":"dev-codex-backend","environment":"test","error":"Cast to ObjectId failed for value \"invalid-id\" (type string) at path \"_id\" for model \"Project\"","pid":1362174}
CastError: Cast to ObjectId failed for value "invalid-id" (type string) at path "_id" for model "Project"
    at ObjectId.cast (/home/lucas/projects/active/daily_use/project-manager/backend/node_modules/mongoose/lib/schema/objectid.js:250:11)
    at ObjectId.SchemaType.applySetters (/home/lucas/projects/active/daily_use/project-manager/backend/node_modules/mongoose/lib/schematype.js:1219:12)
    at ObjectId.SchemaType.castForQuery (/home/lucas/projects/active/daily_use/project-manager/backend/node_modules/mongoose/lib/schematype.js:1633:15)
    at cast (/home/lucas/projects/active/daily_use/project-manager/backend/node_modules/mongoose/lib/cast.js:389:32)
    at model.Query.Query.cast (/home/lucas/projects/active/daily_use/project-manager/backend/node_modules/mongoose/lib/query.js:4927:12)
    at model.Query.Query._castConditions (/home/lucas/projects/active/daily_use/project-manager/backend/node_modules/mongoose/lib/query.js:2237:10)
    at model.Query._findOne (/home/lucas/projects/active/daily_use/project-manager/backend/node_modules/mongoose/lib/query.js:2533:8)
    at model.Query.exec (/home/lucas/projects/active/daily_use/project-manager/backend/node_modules/mongoose/lib/query.js:4447:28)
    at processTicksAndRejections (node:internal/process/task_queues:105:5)
    at /home/lucas/projects/active/daily_use/project-manager/backend/src/routes/projects.ts:139:21
PASS src/tests/error-handling.test.ts (9.398 s)
  Error Handling
    Graceful error handling
      ‚úì should handle invalid MongoDB ObjectId gracefully (619 ms)
      ‚úì should handle non-existent resource requests (337 ms)
      ‚úì should handle malformed JSON gracefully (300 ms)
      ‚úì should handle missing required fields (308 ms)
      ‚úì should handle invalid email format (314 ms)
      ‚úì should handle duplicate user registration (317 ms)
      ‚úì should handle missing authentication token (299 ms)
      ‚úì should handle invalid authentication token (307 ms)
      ‚úì should handle expired JWT token (298 ms)
    Email service failures
      ‚úì should handle password reset without email configured (287 ms)
    Database validation errors
      ‚úì should handle password too short (377 ms)
      ‚úì should handle XSS attempts in input (318 ms)
      ‚úì should handle SQL injection attempts (305 ms)
    Server error handling
      ‚úì should not expose stack traces in production (302 ms)
    Concurrent request handling
      ‚úì should handle multiple concurrent requests (3074 ms)
    Data integrity
      ‚úì should not allow password in response (589 ms)
      ‚úì should not expose sensitive user data (577 ms)

PASS src/tests/services/notificationService.test.ts (7.703 s)
  NotificationService
    getInstance
      ‚úì should return singleton instance (445 ms)
    createNotification
      ‚úì should create a notification (332 ms)
      ‚úì should create notification with project reference (312 ms)
      ‚úì should create notification with user reference (579 ms)
      ‚úì should replace duplicate notifications (332 ms)
    getNotifications
      ‚úì should get user notifications (326 ms)
      ‚úì should support pagination (488 ms)
      ‚úì should filter unread notifications (316 ms)
    markAsRead
      ‚úì should mark notification as read (303 ms)
      ‚úì should not mark notification for different user (573 ms)
    deleteNotification
      ‚úì should delete a notification (304 ms)
      ‚úì should not delete notification for different user (562 ms)
    clearAllNotifications
      ‚úì should clear all user notifications (307 ms)
    hasRecentNotification
      ‚úì should detect recent notification (302 ms)
      ‚úì should not detect old notification (293 ms)
    notification types
      ‚úì should handle project_invitation type (323 ms)
      ‚úì should handle team_member_added type (293 ms)
      ‚úì should handle todo_assigned type (292 ms)
      ‚úì should handle todo_due_soon type (288 ms)
    createBulkNotifications
      ‚úì should create multiple notifications at once (564 ms)

  console.log
    Password reset attempted for non-existent email: test@test.com

      at src/routes/auth.ts:795:15

  console.log
    Password reset attempted for non-existent email: test@test.com

      at src/routes/auth.ts:795:15

  console.log
    Password reset attempted for non-existent email: test@test.com

      at src/routes/auth.ts:795:15

PASS src/tests/rate-limiting.test.ts (7.055 s)
  Rate Limiting
    Auth rate limiting
      ‚úì should block requests after exceeding auth rate limit (520 ms)
      ‚úì should track rate limit attempts in database (101 ms)
      ‚úì should include rate limit headers in responses (31 ms)
    Password reset rate limiting
      ‚úì should block password reset requests after exceeding limit (77 ms)
    Registration rate limiting
      ‚úì should block registration attempts after exceeding auth rate limit (5904 ms)
    Rate limit reset
      ‚úì should reset rate limit after window expires (38 ms)
    Rate limit per IP
      ‚úì should track rate limits per IP address (36 ms)

PASS src/tests/news.test.ts (7.31 s)
  News Routes
    GET /api/news
      ‚úì should get all published news posts without authentication (620 ms)
      ‚úì should return empty array if no published posts (30 ms)
      ‚úì should sort posts by publishedAt descending (293 ms)
    GET /api/news/admin
      ‚úì should get all posts for admin including drafts (311 ms)
      ‚úì should reject non-admin users (289 ms)
      ‚úì should require authentication (22 ms)
    GET /api/news/:id
      ‚úì should get published post by ID without authentication (292 ms)
      ‚úì should reject unpublished post for non-admin (297 ms)
      ‚úì should allow admin to view unpublished post (294 ms)
      ‚úì should return 404 for non-existent post (23 ms)
    POST /api/news
      ‚úì should create news post as admin (301 ms)
      ‚úì should create draft post (290 ms)
      ‚úì should require title and content (300 ms)
      ‚úì should reject non-admin users (295 ms)
      ‚úì should require authentication (25 ms)
    PUT /api/news/:id
      ‚úì should update news post as admin (309 ms)
      ‚úì should set publishedAt when first published (307 ms)
      ‚úì should return 404 for non-existent post (299 ms)
      ‚úì should reject non-admin users (565 ms)
      ‚úì should require authentication (290 ms)
    DELETE /api/news/:id
      ‚úì should delete news post as admin (308 ms)
      ‚úì should return 404 for non-existent post (289 ms)
      ‚úì should reject non-admin users (574 ms)
      ‚úì should require authentication (300 ms)

PASS src/tests/handlers/RelationshipHandlers.test.ts
  RelationshipHandlers
    handleAddRelationship
      ‚úì should trigger wizard when no args or flags (55 ms)
      ‚úì should add a relationship with all fields (70 ms)
      ‚úì should reject old args syntax (30 ms)
      ‚úì should validate required fields (11 ms)
      ‚úì should support different relationship types (23 ms)
    handleViewRelationships
      ‚úì should show wizard when no component specified (8 ms)
      ‚úì should view relationships for specific component (14 ms)
    handleEditRelationship
      ‚úì should show wizard when no args provided (9 ms)
      ‚úì should return error when component not found (8 ms)
    handleDeleteRelationship
      ‚úì should show wizard when no args provided (10 ms)
      ‚úì should return error when component not found (7 ms)

PASS src/tests/activityLogs.test.ts (5.508 s)
  Activity Logs Routes
    GET /api/activity/project/:projectId
      ‚úì should get activity logs for a project (495 ms)
      ‚úì should support pagination with limit and offset (356 ms)
      ‚úì should support filtering by date range (303 ms)
      ‚úì should require authentication (22 ms)
    GET /api/activity/project/:projectId/recent
      ‚úì should get recent activity for a project (304 ms)
      ‚úì should support custom time window in minutes (306 ms)
      ‚úì should require authentication (26 ms)
    GET /api/activity/project/:projectId/active-users
      ‚úì should get active users for a project (325 ms)
      ‚úì should support custom activity window (295 ms)
      ‚úì should not show inactive sessions (307 ms)
      ‚úì should require authentication (20 ms)
    GET /api/activity/user/:userId
      ‚úì should get user's own activity logs (312 ms)
      ‚úì should reject viewing other users' activities (551 ms)
      ‚úì should support filtering by project (298 ms)
      ‚úì should require authentication (20 ms)
    POST /api/activity/smart-join
      ‚úì should log project join (330 ms)
      ‚úì should require authentication (21 ms)
    DELETE /api/activity/project/:projectId/clear
      ‚úì should clear all activity logs for a project (324 ms)
      ‚úì should require authentication (20 ms)
    POST /api/activity/log
      ‚úì should log custom activity (304 ms)
      ‚úì should require authentication (25 ms)

  console.error
    Error fetching project owner plan tier: TypeError: Project_1.Project.findById(...).select is not a function
        at getProjectOwnerPlanTier (/home/lucas/projects/active/daily_use/project-manager/backend/src/utils/retentionUtils.ts:55:55)
        at TeamHandlers.handleRemoveMember (/home/lucas/projects/active/daily_use/project-manager/backend/src/services/handlers/TeamHandlers.ts:273:51)
        at processTicksAndRejections (node:internal/process/task_queues:105:5)
        at Object.<anonymous> (/home/lucas/projects/active/daily_use/project-manager/backend/src/tests/handlers/TeamHandlers.test.ts:270:22)

      60 |     return getUserPlanTier(project.ownerId);
      61 |   } catch (error) {
    > 62 |     console.error('Error fetching project owner plan tier:', error);
         |             ^
      63 |     return DEFAULT_PLAN_TIER;
      64 |   }
      65 | }

      at getProjectOwnerPlanTier (src/utils/retentionUtils.ts:62:13)
      at TeamHandlers.handleRemoveMember (src/services/handlers/TeamHandlers.ts:273:51)
      at Object.<anonymous> (src/tests/handlers/TeamHandlers.test.ts:270:22)

PASS src/tests/handlers/TeamHandlers.test.ts
  TeamHandlers
    handleViewTeam
      ‚úì should view team members (2 ms)
      ‚úì should show message when no team members (1 ms)
    handleInviteMember
      ‚úì should validate email/username is provided (1 ms)
      ‚úì should validate role (1 ms)
      ‚úì should prevent self-invitation (1 ms)
      ‚úì should check if user is already a member (1 ms)
    handleRemoveMember
      ‚úì should validate member identifier is provided (2 ms)
      ‚úì should find and remove member by email (20 ms)
      ‚úì should error when member not found (2 ms)
      ‚úì should error when user is not a team member (1 ms)

PASS src/tests/handlers/SearchHandlers.test.ts
  SearchHandlers
    handleSearch
      ‚úì should return error when query is empty (16 ms)
      ‚úì should search todos in project (5 ms)
      ‚úì should search notes in project (6 ms)
      ‚úì should search devlog in project (5 ms)
      ‚úì should search components in project (7 ms)
      ‚úì should search across multiple types (4 ms)
      ‚úì should return empty results when no matches found (2 ms)
      ‚úì should search case-insensitively (3 ms)
      ‚úì should search multi-word queries (3 ms)

PASS src/tests/billing.test.ts
  Billing and Payment Routes
    GET /api/billing/info
      ‚úì should return user billing info for free tier (452 ms)
      ‚úì should reject request without authentication (305 ms)
      ‚úì should return billing info for pro user (305 ms)
    POST /api/billing/create-checkout-session
      ‚úì should create checkout session successfully (321 ms)
      ‚úì should reject invalid plan tier (298 ms)
      ‚úì should reject request without authentication (281 ms)
    POST /api/billing/cancel-subscription
      ‚úì should handle cancellation for user without subscription (293 ms)
      ‚úì should reject request without authentication (284 ms)
    POST /api/billing/webhook
      ‚úì should require authentication (webhook protected in test) (286 ms)
    Basic functionality
      ‚úì should handle plan limits correctly (280 ms)
      ‚úì should allow plan upgrades (286 ms)

  console.log
    [TERMINAL ANALYTICS] Tracking terminal command: {
      userId: '6913c8a29acddfa2b18c576c',
      commandType: 'help',
      responseType: 'info'
    }

      at src/routes/terminal.ts:47:15

  console.log
    [TERMINAL ANALYTICS] Track result: SUCCESS

      at src/routes/terminal.ts:64:15

  console.log
    [TERMINAL ANALYTICS] Tracking terminal command: {
      userId: '6913c8a29acddfa2b18c577f',
      commandType: 'help',
      responseType: 'info'
    }

      at src/routes/terminal.ts:47:15

  console.log
    [TERMINAL ANALYTICS] Track result: SUCCESS

      at src/routes/terminal.ts:64:15

  console.log
    [TERMINAL ANALYTICS] Tracking terminal command: {
      userId: '6913c8a39acddfa2b18c5794',
      commandType: 'help',
      responseType: 'info'
    }

      at src/routes/terminal.ts:47:15

  console.log
    [TERMINAL ANALYTICS] Track result: SUCCESS

      at src/routes/terminal.ts:64:15

PASS src/tests/terminal.test.ts
  Terminal Routes
    POST /api/terminal/execute
      ‚úì should require authentication (228 ms)
      ‚úì should reject empty command (341 ms)
      ‚úì should reject non-string command (302 ms)
      ‚úì should execute help command (316 ms)
      ‚úì should handle command with project context (321 ms)
      ‚úì should return response for valid command (315 ms)
    GET /api/terminal/commands
      ‚úì should require authentication (23 ms)
      ‚úì should get available commands (290 ms)
      ‚úì should include command metadata (294 ms)
      ‚úì should require authentication (20 ms)
      ‚úì should get commands information (294 ms)
    GET /api/terminal/projects
      ‚úì should require authentication (25 ms)
      ‚úì should get user projects (302 ms)

  console.error
    Get notifications error: Error: Database error
        at Object.<anonymous> (/home/lucas/projects/active/daily_use/project-manager/backend/src/tests/notifications.test.ts:95:66)
        at Promise.finally.completed (/home/lucas/projects/active/daily_use/project-manager/backend/node_modules/jest-circus/build/jestAdapterInit.js:1556:28)
        at new Promise (<anonymous>)
        at callAsyncCircusFn (/home/lucas/projects/active/daily_use/project-manager/backend/node_modules/jest-circus/build/jestAdapterInit.js:1496:10)
        at _callCircusTest (/home/lucas/projects/active/daily_use/project-manager/backend/node_modules/jest-circus/build/jestAdapterInit.js:1006:40)
        at processTicksAndRejections (node:internal/process/task_queues:105:5)
        at _runTest (/home/lucas/projects/active/daily_use/project-manager/backend/node_modules/jest-circus/build/jestAdapterInit.js:946:3)
        at _runTestsForDescribeBlock (/home/lucas/projects/active/daily_use/project-manager/backend/node_modules/jest-circus/build/jestAdapterInit.js:839:13)
        at _runTestsForDescribeBlock (/home/lucas/projects/active/daily_use/project-manager/backend/node_modules/jest-circus/build/jestAdapterInit.js:829:11)
        at _runTestsForDescribeBlock (/home/lucas/projects/active/daily_use/project-manager/backend/node_modules/jest-circus/build/jestAdapterInit.js:829:11)
        at run (/home/lucas/projects/active/daily_use/project-manager/backend/node_modules/jest-circus/build/jestAdapterInit.js:757:3)
        at runAndTransformResultsToJestFormat (/home/lucas/projects/active/daily_use/project-manager/backend/node_modules/jest-circus/build/jestAdapterInit.js:1917:21)
        at jestAdapter (/home/lucas/projects/active/daily_use/project-manager/backend/node_modules/jest-circus/build/runner.js:101:19)
        at runTestInternal (/home/lucas/projects/active/daily_use/project-manager/backend/node_modules/jest-runner/build/index.js:275:16)
        at runTest (/home/lucas/projects/active/daily_use/project-manager/backend/node_modules/jest-runner/build/index.js:343:7)

      24 |     });
      25 |   } catch (error) {
    > 26 |     console.error('Get notifications error:', error);
         |             ^
      27 |     res.status(500).json({ message: 'Server error fetching notifications' });
      28 |   }
      29 | });

      at src/routes/notifications.ts:26:13

PASS src/tests/notifications.test.ts
  Notification Routes
    GET /api/notifications
      ‚úì should get user notifications with default pagination (550 ms)
      ‚úì should get notifications with custom pagination and filters (303 ms)
      ‚úì should require authentication (281 ms)
      ‚úì should handle server errors (290 ms)
    PATCH /api/notifications/:id/read
      ‚úì should mark notification as read (281 ms)
      ‚úì should handle invalid notification ID (282 ms)
    PATCH /api/notifications/read-all
      ‚úì should mark all notifications as read (287 ms)
    DELETE /api/notifications/:id
      ‚úì should delete notification (281 ms)
      ‚úì should handle notification not found (281 ms)

PASS src/tests/tutorial.test.ts
  Tutorial Routes
    GET /api/tutorial/steps
      ‚úì should return all tutorial steps without authentication (117 ms)
    GET /api/tutorial/progress
      ‚úì should return tutorial progress for authenticated user (354 ms)
      ‚úì should require authentication (22 ms)
    PATCH /api/tutorial/progress
      ‚úì should update tutorial progress (294 ms)
      ‚úì should require currentStep and completedSteps (284 ms)
    POST /api/tutorial/complete
      ‚úì should mark tutorial as completed (296 ms)
    PATCH /api/tutorial/skip
      ‚úì should mark tutorial as skipped (286 ms)
    POST /api/tutorial/reset
      ‚úì should reset tutorial progress (314 ms)

  console.log
    Password reset attempted for non-existent email: nonexistent@test.com

      at src/routes/auth.ts:795:15

PASS src/tests/password-reset.test.ts
  Password Reset Flow
    ‚úì should complete full password reset flow (1611 ms)
    ‚úì should reject invalid reset tokens (29 ms)
    ‚úì should reject expired reset tokens (352 ms)
    ‚úì should not reveal if email exists (enumeration prevention) (31 ms)

PASS src/tests/admin.test.ts
  Admin Routes
    GET /api/admin/users
      ‚úì should get all users for admin (608 ms)
      ‚úì should reject request without authentication (293 ms)
    Admin Authentication
      ‚úì should require admin role (560 ms)

PASS src/tests/analytics.test.ts
  Analytics Routes
    POST /api/analytics/track
      ‚úì should track analytics event (431 ms)
      ‚úì should reject request without authentication (299 ms)
    GET /api/analytics/user/:userId
      ‚úì should get user analytics data (314 ms)
      ‚úì should require authentication (290 ms)

PASS src/tests/ideas.test.ts
  Ideas Routes
    GET /api/ideas
      ‚úì should get user ideas (452 ms)
      ‚úì should require authentication (304 ms)
    POST /api/ideas
      ‚úì should create a new idea (299 ms)
      ‚úì should validate required fields (279 ms)
      ‚úì should require authentication (290 ms)

PASS src/tests/services/commandExecutor.test.ts
  commandExecutor
    ‚úì should execute add todo command (140 ms)
    ‚úì should execute view todos command (51 ms)
    ‚úì should execute search command (13 ms)
    ‚úì should execute help command (17 ms)
    ‚úì should handle invalid commands (12 ms)
    ‚úì should handle missing slash (15 ms)
    ‚úì should execute view settings (12 ms)
    ‚úì should execute view team (16 ms)
    ‚úì should execute view stack (13 ms)
    ‚úì should execute export command (16 ms)

  console.log
    [TODO ANALYTICS] Tracking todo create: {
      userId: '6913c8b294a102d3a4201480',
      projectId: '6913c8b294a102d3a4201481',
      priority: 'medium'
    }

      at TodoHandlers.handleAddTodo (src/services/handlers/crud/TodoHandlers.ts:171:15)

  console.log
    [TODO ANALYTICS] Track result: SUCCESS

      at TodoHandlers.handleAddTodo (src/services/handlers/crud/TodoHandlers.ts:188:15)

  console.log
    [TODO ANALYTICS] Tracking todo create: {
      userId: '6913c8b294a102d3a4201480',
      projectId: '6913c8b294a102d3a4201481',
      priority: 'high'
    }

      at TodoHandlers.handleAddTodo (src/services/handlers/crud/TodoHandlers.ts:171:15)

  console.log
    [TODO ANALYTICS] Track result: SUCCESS

      at TodoHandlers.handleAddTodo (src/services/handlers/crud/TodoHandlers.ts:188:15)

PASS src/tests/handlers/TodoHandlers.test.ts
  TodoHandlers
    handleAddTodo
      ‚úì should add a todo with wizard when no args (44 ms)
      ‚úì should add a simple todo with title only (64 ms)
      ‚úì should add a todo with all fields (41 ms)
      ‚úì should validate required title (9 ms)
    handleViewTodos
      ‚úì should view all todos (8 ms)
      ‚úì should return all todos without filtering (11 ms)
    handleEditTodo
      ‚úì should edit todo title (7 ms)
      ‚úì should edit todo status (8 ms)
      ‚úì should return error when todo not found (10 ms)
    handleDeleteTodo
      ‚úì should delete a todo with confirmation (13 ms)
      ‚úì should return error when deleting non-existent todo (7 ms)
    handleCompleteTodo
      ‚úì should complete a todo (18 ms)
    handleAssignTodo
      ‚úì should require correct args format (8 ms)

  console.error
    Error checking team member limit: CastError: Cast to ObjectId failed for value "project123" (type string) at path "projectId" for model "TeamMember"
        at ObjectId.cast (/home/lucas/projects/active/daily_use/project-manager/backend/node_modules/mongoose/lib/schema/objectid.js:250:11)
        at ObjectId.SchemaType.applySetters (/home/lucas/projects/active/daily_use/project-manager/backend/node_modules/mongoose/lib/schematype.js:1219:12)
        at ObjectId.SchemaType.castForQuery (/home/lucas/projects/active/daily_use/project-manager/backend/node_modules/mongoose/lib/schematype.js:1633:15)
        at cast (/home/lucas/projects/active/daily_use/project-manager/backend/node_modules/mongoose/lib/cast.js:389:32)
        at model.Query.Query.cast (/home/lucas/projects/active/daily_use/project-manager/backend/node_modules/mongoose/lib/query.js:4927:12)
        at model.Query._countDocuments (/home/lucas/projects/active/daily_use/project-manager/backend/node_modules/mongoose/lib/query.js:2659:10)
        at model.Query.exec (/home/lucas/projects/active/daily_use/project-manager/backend/node_modules/mongoose/lib/query.js:4447:28)
        at processTicksAndRejections (node:internal/process/task_queues:105:5)
        at checkTeamMemberLimit (/home/lucas/projects/active/daily_use/project-manager/backend/src/middleware/planLimits.ts:86:32)
        at Object.<anonymous> (/home/lucas/projects/active/daily_use/project-manager/backend/src/tests/middleware/planLimits.test.ts:126:7) {
      stringValue: '"project123"',
      messageFormat: undefined,
      kind: 'ObjectId',
      value: 'project123',
      path: 'projectId',
      reason: BSONError: Argument passed in must be a string of 12 bytes or a string of 24 hex characters or an integer
          at new ObjectId (/home/lucas/projects/active/daily_use/project-manager/backend/node_modules/bson/src/objectid.ts:88:15)
          at castObjectId (/home/lucas/projects/active/daily_use/project-manager/backend/node_modules/mongoose/lib/cast/objectid.js:25:12)
          at ObjectId.cast (/home/lucas/projects/active/daily_use/project-manager/backend/node_modules/mongoose/lib/schema/objectid.js:248:12)
          at ObjectId.SchemaType.applySetters (/home/lucas/projects/active/daily_use/project-manager/backend/node_modules/mongoose/lib/schematype.js:1219:12)
          at ObjectId.SchemaType.castForQuery (/home/lucas/projects/active/daily_use/project-manager/backend/node_modules/mongoose/lib/schematype.js:1633:15)
          at cast (/home/lucas/projects/active/daily_use/project-manager/backend/node_modules/mongoose/lib/cast.js:389:32)
          at model.Query.Query.cast (/home/lucas/projects/active/daily_use/project-manager/backend/node_modules/mongoose/lib/query.js:4927:12)
          at model.Query._countDocuments (/home/lucas/projects/active/daily_use/project-manager/backend/node_modules/mongoose/lib/query.js:2659:10)
          at model.Query.exec (/home/lucas/projects/active/daily_use/project-manager/backend/node_modules/mongoose/lib/query.js:4447:28)
          at processTicksAndRejections (node:internal/process/task_queues:105:5)
          at checkTeamMemberLimit (/home/lucas/projects/active/daily_use/project-manager/backend/src/middleware/planLimits.ts:86:32)
          at Object.<anonymous> (/home/lucas/projects/active/daily_use/project-manager/backend/src/tests/middleware/planLimits.test.ts:126:7),
      valueType: 'string',
      model: Model { TeamMember }
    }

       98 |     next();
       99 |   } catch (error) {
    > 100 |     console.error('Error checking team member limit:', error);
          |             ^
      101 |     res.status(500).json({ error: 'Failed to check team member limits' });
      102 |   }
      103 | };

      at checkTeamMemberLimit (src/middleware/planLimits.ts:100:13)
      at Object.<anonymous> (src/tests/middleware/planLimits.test.ts:126:7)

PASS src/tests/middleware/planLimits.test.ts
  planLimits middleware
    checkProjectLimit
      ‚úì should allow project creation within limit (18 ms)
      ‚úì should block project creation when limit reached (6 ms)
      ‚úì should allow unlimited projects for enterprise users (6 ms)
      ‚úì should bypass limits for admin users (6 ms)
    checkTeamMemberLimit
      ‚úì should allow adding team member within limit (75 ms)
      ‚úì should bypass limits for admin project owners (3 ms)
      ‚úì should return 404 if project not found (4 ms)

PASS src/tests/handlers/ComponentHandlers.test.ts
  ComponentHandlers
    handleAddComponent
      ‚úì should trigger wizard when no args or flags (47 ms)
      ‚úì should add a component with all fields (65 ms)
      ‚úì should reject old separator syntax (18 ms)
      ‚úì should validate required fields (18 ms)
      ‚úì should add frontend component (19 ms)
    handleViewComponents
      ‚úì should view all components (8 ms)
      ‚úì should return all components grouped by feature (8 ms)
    handleEditComponent
      ‚úì should edit component title (9 ms)
      ‚úì should edit component content (11 ms)
      ‚úì should edit multiple fields at once (7 ms)
      ‚úì should return error when component not found (8 ms)
    handleDeleteComponent
      ‚úì should delete a component with confirmation (18 ms)
      ‚úì should return error when deleting non-existent component (7 ms)

PASS src/tests/services/reminderService.test.ts
  ReminderService
    getInstance
      ‚úì should return singleton instance (1 ms)
    initialize
      ‚úì should initialize cron jobs (1 ms)
      ‚úì should not initialize twice (1 ms)

PASS src/tests/handlers/NoteHandlers.test.ts
  NoteHandlers
    handleAddNote
      ‚úì should add a note with title and content (85 ms)
      ‚úì should show wizard when no args or flags (36 ms)
    handleViewNotes
      ‚úì should view all notes (21 ms)
    handleEditNote
      ‚úì should edit note title (14 ms)
    handleDeleteNote
      ‚úì should delete a note with confirmation (31 ms)

PASS src/tests/handlers/DevLogHandlers.test.ts
  DevLogHandlers
    handleAddDevLog
      ‚úì should add a devlog with content (75 ms)
      ‚úì should show wizard when no content provided (32 ms)
    handleViewDevLog
      ‚úì should view all devlogs (22 ms)
    handleEditDevLog
      ‚úì should edit devlog content (17 ms)
    handleDeleteDevLog
      ‚úì should delete a devlog with confirmation (15 ms)

  console.error
    ValidationError: Custom keyGenerator appears to use request IP without calling the ipKeyGenerator helper function for IPv6 addresses. This could allow IPv6 users to bypass limits. See https://express-rate-limit.github.io/ERR_ERL_KEY_GEN_IPV6/ for more information.
        at Object.keyGeneratorIpFallback (/home/lucas/projects/active/daily_use/project-manager/backend/node_modules/express-rate-limit/dist/index.cjs:578:13)
        at Object.wrappedValidations.<computed> [as keyGeneratorIpFallback] (/home/lucas/projects/active/daily_use/project-manager/backend/node_modules/express-rate-limit/dist/index.cjs:606:22)
        at parseOptions (/home/lucas/projects/active/daily_use/project-manager/backend/node_modules/express-rate-limit/dist/index.cjs:675:16)
        at rateLimit (/home/lucas/projects/active/daily_use/project-manager/backend/node_modules/express-rate-limit/dist/index.cjs:753:18)
        at Object.<anonymous> (/home/lucas/projects/active/daily_use/project-manager/backend/src/middleware/commandSecurity.ts:11:50)
        at Runtime._execModule (/home/lucas/projects/active/daily_use/project-manager/backend/node_modules/jest-runtime/build/index.js:1268:24)
        at Runtime._loadModule (/home/lucas/projects/active/daily_use/project-manager/backend/node_modules/jest-runtime/build/index.js:944:12)
        at Runtime.requireModule (/home/lucas/projects/active/daily_use/project-manager/backend/node_modules/jest-runtime/build/index.js:832:12)
        at Runtime.requireModuleOrMock (/home/lucas/projects/active/daily_use/project-manager/backend/node_modules/jest-runtime/build/index.js:964:21)
        at Object.<anonymous> (/home/lucas/projects/active/daily_use/project-manager/backend/src/tests/middleware/commandSecurity.test.ts:2:1)
        at Runtime._execModule (/home/lucas/projects/active/daily_use/project-manager/backend/node_modules/jest-runtime/build/index.js:1268:24)
        at Runtime._loadModule (/home/lucas/projects/active/daily_use/project-manager/backend/node_modules/jest-runtime/build/index.js:944:12)
        at Runtime.requireModule (/home/lucas/projects/active/daily_use/project-manager/backend/node_modules/jest-runtime/build/index.js:832:12)
        at jestAdapter (/home/lucas/projects/active/daily_use/project-manager/backend/node_modules/jest-circus/build/runner.js:95:13)
        at runTestInternal (/home/lucas/projects/active/daily_use/project-manager/backend/node_modules/jest-runner/build/index.js:275:16)
        at runTest (/home/lucas/projects/active/daily_use/project-manager/backend/node_modules/jest-runner/build/index.js:343:7) {
      code: 'ERR_ERL_KEY_GEN_IPV6',
      help: 'https://express-rate-limit.github.io/ERR_ERL_KEY_GEN_IPV6/'
    }

       9 |  * Stricter than normal API rate limits to prevent abuse
      10 |  */
    > 11 | export const terminalCommandRateLimit = rateLimit({
         |                                                  ^
      12 |   windowMs: 1 * 60 * 1000, // 1 minute
      13 |   max: 20, // 20 commands per minute per user
      14 |   standardHeaders: true,

      at Object.wrappedValidations.<computed> [as keyGeneratorIpFallback] (node_modules/express-rate-limit/dist/index.cjs:612:24)
      at parseOptions (node_modules/express-rate-limit/dist/index.cjs:675:16)
      at rateLimit (node_modules/express-rate-limit/dist/index.cjs:753:18)
      at Object.<anonymous> (src/middleware/commandSecurity.ts:11:50)
      at Object.<anonymous> (src/tests/middleware/commandSecurity.test.ts:2:1)

  console.error
    ValidationError: Custom keyGenerator appears to use request IP without calling the ipKeyGenerator helper function for IPv6 addresses. This could allow IPv6 users to bypass limits. See https://express-rate-limit.github.io/ERR_ERL_KEY_GEN_IPV6/ for more information.
        at Object.keyGeneratorIpFallback (/home/lucas/projects/active/daily_use/project-manager/backend/node_modules/express-rate-limit/dist/index.cjs:578:13)
        at Object.wrappedValidations.<computed> [as keyGeneratorIpFallback] (/home/lucas/projects/active/daily_use/project-manager/backend/node_modules/express-rate-limit/dist/index.cjs:606:22)
        at parseOptions (/home/lucas/projects/active/daily_use/project-manager/backend/node_modules/express-rate-limit/dist/index.cjs:675:16)
        at rateLimit (/home/lucas/projects/active/daily_use/project-manager/backend/node_modules/express-rate-limit/dist/index.cjs:753:18)
        at Object.<anonymous> (/home/lucas/projects/active/daily_use/project-manager/backend/src/middleware/commandSecurity.ts:47:54)
        at Runtime._execModule (/home/lucas/projects/active/daily_use/project-manager/backend/node_modules/jest-runtime/build/index.js:1268:24)
        at Runtime._loadModule (/home/lucas/projects/active/daily_use/project-manager/backend/node_modules/jest-runtime/build/index.js:944:12)
        at Runtime.requireModule (/home/lucas/projects/active/daily_use/project-manager/backend/node_modules/jest-runtime/build/index.js:832:12)
        at Runtime.requireModuleOrMock (/home/lucas/projects/active/daily_use/project-manager/backend/node_modules/jest-runtime/build/index.js:964:21)
        at Object.<anonymous> (/home/lucas/projects/active/daily_use/project-manager/backend/src/tests/middleware/commandSecurity.test.ts:2:1)
        at Runtime._execModule (/home/lucas/projects/active/daily_use/project-manager/backend/node_modules/jest-runtime/build/index.js:1268:24)
        at Runtime._loadModule (/home/lucas/projects/active/daily_use/project-manager/backend/node_modules/jest-runtime/build/index.js:944:12)
        at Runtime.requireModule (/home/lucas/projects/active/daily_use/project-manager/backend/node_modules/jest-runtime/build/index.js:832:12)
        at jestAdapter (/home/lucas/projects/active/daily_use/project-manager/backend/node_modules/jest-circus/build/runner.js:95:13)
        at runTestInternal (/home/lucas/projects/active/daily_use/project-manager/backend/node_modules/jest-runner/build/index.js:275:16)
        at runTest (/home/lucas/projects/active/daily_use/project-manager/backend/node_modules/jest-runner/build/index.js:343:7) {
      code: 'ERR_ERL_KEY_GEN_IPV6',
      help: 'https://express-rate-limit.github.io/ERR_ERL_KEY_GEN_IPV6/'
    }

      45 |  * More lenient than command execution
      46 |  */
    > 47 | export const terminalSuggestionsRateLimit = rateLimit({
         |                                                      ^
      48 |   windowMs: 1 * 60 * 1000, // 1 minute
      49 |   max: 60, // 60 requests per minute
      50 |   standardHeaders: true,

      at Object.wrappedValidations.<computed> [as keyGeneratorIpFallback] (node_modules/express-rate-limit/dist/index.cjs:612:24)
      at parseOptions (node_modules/express-rate-limit/dist/index.cjs:675:16)
      at rateLimit (node_modules/express-rate-limit/dist/index.cjs:753:18)
      at Object.<anonymous> (src/middleware/commandSecurity.ts:47:54)
      at Object.<anonymous> (src/tests/middleware/commandSecurity.test.ts:2:1)

PASS src/tests/middleware/commandSecurity.test.ts
  commandSecurity middleware
    validateCommandFormat
      ‚úì should allow valid commands starting with / (1 ms)
      ‚úì should reject commands not starting with / (1 ms)
      ‚úì should reject missing command (1 ms)
    sanitizeCommand
      ‚úì should allow safe commands (2 ms)
      ‚úì should block commands with script tags (12 ms)
      ‚úì should block commands with eval (2 ms)
      ‚úì should reject commands that are too long (1 ms)
    logCommandExecution
      ‚úì should log command and call next (2 ms)

PASS src/tests/health.test.ts
  Health Check Routes
    GET /api/health
      ‚úì should return health status (54 ms)
      ‚úì should return valid timestamp format (32 ms)
      ‚úì should include environment info (20 ms)
    GET /api/ready
      ‚úì should return ready status when database is connected (25 ms)
      ‚úì should return valid timestamp format (16 ms)
      ‚úì should verify database connectivity (12 ms)
      ‚úì should include uptime in response (14 ms)
    GET /api/live
      ‚úì should return alive status (12 ms)
      ‚úì should return valid timestamp format (13 ms)
      ‚úì should always succeed when server is running (23 ms)
    Health Check Integration
      ‚úì should have consistent timestamps across health endpoints (24 ms)
      ‚úì should have consistent uptime values (16 ms)

PASS src/tests/middleware/validation.test.ts
  Validation Middleware
    Helper Functions
      sanitizeString
        ‚úì should trim whitespace (2 ms)
        ‚úì should remove null bytes (1 ms)
        ‚úì should remove control characters (1 ms)
        ‚úì should remove HTML tags (10 ms)
        ‚úì should return empty string for non-string input (1 ms)
        ‚úì should handle empty strings (3 ms)
      isValidEmail
        ‚úì should accept valid email addresses (1 ms)
        ‚úì should reject invalid email addresses (6 ms)
        ‚úì should handle case insensitivity (2 ms)
      isStrongPassword
        ‚úì should accept strong passwords (1 ms)
        ‚úì should reject passwords without uppercase (1 ms)
        ‚úì should reject passwords without lowercase (1 ms)
        ‚úì should reject passwords without numbers (1 ms)
        ‚úì should reject passwords without special characters (1 ms)
        ‚úì should reject passwords shorter than 12 characters (1 ms)
      isValidObjectId
        ‚úì should accept valid MongoDB ObjectIds (1 ms)
        ‚úì should reject invalid ObjectIds (1 ms)
    validateUserRegistration
      ‚úì should accept valid registration data (2 ms)
      ‚úì should reject missing email (1 ms)
      ‚úì should reject missing password (1 ms)
      ‚úì should reject invalid email format (2 ms)
      ‚úì should reject weak passwords (1 ms)
      ‚úì should reject firstName that is too long (2 ms)
      ‚úì should sanitize and lowercase email (1 ms)
      ‚úì should set default theme to retro (1 ms)
      ‚úì should handle validation errors gracefully (5 ms)
    validateUserLogin
      ‚úì should accept valid login data (1 ms)
      ‚úì should reject missing email (1 ms)
      ‚úì should reject missing password (1 ms)
      ‚úì should reject invalid email format (1 ms)
      ‚úì should sanitize and lowercase email (1 ms)
      ‚úì should reject non-string passwords (1 ms)
      ‚úì should handle validation errors gracefully (1 ms)
    validatePasswordReset
      ‚úì should accept valid forgot-password request (2 ms)
      ‚úì should accept valid reset-password request (1 ms)
      ‚úì should reject forgot-password without email (1 ms)
      ‚úì should reject reset-password without token (1 ms)
      ‚úì should reject weak password in reset (1 ms)
      ‚úì should handle validation errors gracefully (1 ms)
    validateObjectId
      ‚úì should accept valid ObjectId (1 ms)
      ‚úì should reject invalid ObjectId (1 ms)
      ‚úì should reject missing ObjectId (1 ms)
      ‚úì should work with custom parameter names
      ‚úì should handle validation errors gracefully (1 ms)
    validateProjectData
      ‚úì should accept valid project creation data (5 ms)
      ‚úì should reject POST without name (1 ms)
      ‚úì should accept PUT without all fields (1 ms)
      ‚úì should reject name that is too long (1 ms)
      ‚úì should reject description that is too long (1 ms)
      ‚úì should sanitize tags and limit to 10 (1 ms)
      ‚úì should filter out tags that are too long (1 ms)
      ‚úì should handle validation errors gracefully (1 ms)
    sanitizeBody
      ‚úì should sanitize all string fields in body (3 ms)
      ‚úì should handle empty body (1 ms)
      ‚úì should handle null body (1 ms)
      ‚úì should handle sanitization errors gracefully (1 ms)

PASS src/tests/base.test.ts
  BaseRouter
    Route Configuration
      ‚úì should register GET routes (19 ms)
      ‚úì should register POST routes (10 ms)
      ‚úì should register PUT routes (10 ms)
      ‚úì should register PATCH routes (8 ms)
      ‚úì should register DELETE routes (6 ms)
    Authentication Middleware
      ‚úì should require authentication by default (9 ms)
      ‚úì should allow access with valid token (7 ms)
      ‚úì should skip auth when requireAuth is false (6 ms)
    Custom Middleware
      ‚úì should execute custom middleware before handler (11 ms)
      ‚úì should call handler when custom middleware passes (6 ms)
    Response Helpers
      sendSuccess
        ‚úì should send success response with data (6 ms)
        ‚úì should include custom data in response (8 ms)
      sendError
        ‚úì should send error response with custom status code (6 ms)
        ‚úì should default to 400 status code (1 ms)
    Async Error Handling
      ‚úì should catch and handle async errors (6 ms)
      ‚úì should handle synchronous handlers without errors (11 ms)
    Base Path Handling
      ‚úì should correctly prefix routes with base path (6 ms)
      ‚úì should return 404 for routes without base path (8 ms)
    Router Instance
      ‚úì should return Express Router instance (1 ms)

PASS src/tests/services/commandParser.test.ts
  CommandParser
    parse
      ‚úì should parse add todo command (3 ms)
      ‚úì should parse flags (2 ms)
      ‚úì should parse project mentions (1 ms)
      ‚úì should handle quoted strings (2 ms)
      ‚úì should error on missing leading slash
      ‚úì should parse view commands (1 ms)
      ‚úì should parse edit commands (2 ms)
      ‚úì should parse delete commands (1 ms)
      ‚úì should parse search command (1 ms)
      ‚úì should parse help command (5 ms)
      ‚úì should handle unknown commands (1 ms)
      ‚úì should parse boolean flags (1 ms)
      ‚úì should parse multiple args (2 ms)
      ‚úì should handle escaped quotes (1 ms)
      ‚úì should parse add component (2 ms)
      ‚úì should parse add devlog (2 ms)
      ‚úì should parse view stack (2 ms)
      ‚úì should parse team commands (1 ms)
      ‚úì should parse invite command (1 ms)
      ‚úì should parse settings commands (2 ms)
      ‚úì should parse set name (1 ms)
      ‚úì should parse add tag (1 ms)
      ‚úì should parse complete todo (7 ms)
      ‚úì should parse assign todo (2 ms)
      ‚úì should parse relationship commands (2 ms)
      ‚úì should parse export command (2 ms)
      ‚úì should parse summary command (1 ms)
    helper functions
      ‚úì should get flag from Map (1 ms)
      ‚úì should get flag from Record (1 ms)
      ‚úì should get flag count from Map (1 ms)
      ‚úì should get flag count from Record (1 ms)
      ‚úì should check flag existence in Map (1 ms)
      ‚úì should check flag existence in Record (1 ms)

PASS src/tests/middleware/requestLogger.test.ts
  Request Logger Middleware
    requestLogger
      ‚úì should log incoming request (2 ms)
      ‚úì should use userId when available (2 ms)
      ‚úì should use user._id when userId not available (1 ms)
      ‚úì should generate request ID when not provided (2 ms)
      ‚úì should use connection.remoteAddress when ip not available (2 ms)
      ‚úì should log successful response (2xx) (5 ms)
      ‚úì should log client error response (4xx) (10 ms)
      ‚úì should log server error response (5xx) (2 ms)
      ‚úì should measure request duration (13 ms)
      ‚úì should call original res.end with arguments (2 ms)
      ‚úì should handle missing headers gracefully (1 ms)
      ‚úì should handle different HTTP methods (3 ms)
    authLogger
      ‚úì should log authentication event (1 ms)
      ‚úì should include userId when available (1 ms)
      ‚úì should include user email when available (2 ms)
      ‚úì should include additional context when provided (1 ms)
      ‚úì should use connection.remoteAddress when ip not available (1 ms)
      ‚úì should handle different authentication actions (1 ms)
      ‚úì should handle missing request data gracefully (1 ms)
    businessLogger
      ‚úì should log business operation (1 ms)
      ‚úì should include all context fields (1 ms)
      ‚úì should handle empty context (2 ms)
      ‚úì should handle different operation types (2 ms)
      ‚úì should handle complex context objects (2 ms)
    Integration
      ‚úì should work together for authenticated request flow (9 ms)

FAIL src/tests/services/cleanupService.test.ts
  ‚óè Test suite failed to run

    [96msrc/tests/services/cleanupService.test.ts[0m:[93m43[0m:[93m27[0m - [91merror[0m[90m TS2540: [0mCannot assign to 'db' because it is a read-only property.

    [7m43[0m       mongoose.connection.db = {
    [7m  [0m [91m                          ~~[0m
    [96msrc/tests/services/cleanupService.test.ts[0m:[93m110[0m:[93m21[0m - [91merror[0m[90m TS2339: [0mProperty 'expired' does not exist on type '{ markedExpired: number; message: string; }'.

    [7m110[0m       expect(result.expired).toBe(10);
    [7m   [0m [91m                    ~~~~~~~[0m
    [96msrc/tests/services/cleanupService.test.ts[0m:[93m111[0m:[93m21[0m - [91merror[0m[90m TS2339: [0mProperty 'deleted' does not exist on type '{ markedExpired: number; message: string; }'.

    [7m111[0m       expect(result.deleted).toBe(5);
    [7m   [0m [91m                    ~~~~~~~[0m

FAIL src/tests/handlers/UtilityHandlers.test.ts
  ‚óè Test suite failed to run

    [96msrc/tests/handlers/UtilityHandlers.test.ts[0m:[93m32[0m:[93m45[0m - [91merror[0m[90m TS2554: [0mExpected 1 arguments, but got 2.

    [7m32[0m     handler = new UtilityHandlers(mockUser, mockProject);
    [7m  [0m [91m                                            ~~~~~~~~~~~[0m
    [96msrc/tests/handlers/UtilityHandlers.test.ts[0m:[93m54[0m:[93m30[0m - [91merror[0m[90m TS2554: [0mExpected 1-2 arguments, but got 0.

    [7m54[0m       const result = handler.handleLLMContext();
    [7m  [0m [91m                             ~~~~~~~~~~~~~~~~[0m

      [96msrc/services/handlers/UtilityHandlers.ts[0m:[93m1768[0m:[93m26[0m
        [7m1768[0m   async handleLLMContext(parsed: ParsedCommand, currentProjectId?: string): Promise<CommandResponse> {
        [7m    [0m [96m                         ~~~~~~~~~~~~~~~~~~~~~[0m
        An argument for 'parsed' was not provided.
    [96msrc/tests/handlers/UtilityHandlers.test.ts[0m:[93m56[0m:[93m21[0m - [91merror[0m[90m TS2339: [0mProperty 'type' does not exist on type 'Promise<CommandResponse>'.

    [7m56[0m       expect(result.type).toBe('info');
    [7m  [0m [91m                    ~~~~[0m

      [96msrc/tests/handlers/UtilityHandlers.test.ts[0m:[93m56[0m:[93m21[0m
        [7m56[0m       expect(result.type).toBe('info');
        [7m  [0m [96m                    ~~~~[0m
        Did you forget to use 'await'?
    [96msrc/tests/handlers/UtilityHandlers.test.ts[0m:[93m57[0m:[93m21[0m - [91merror[0m[90m TS2339: [0mProperty 'data' does not exist on type 'Promise<CommandResponse>'.

    [7m57[0m       expect(result.data).toBeDefined();
    [7m  [0m [91m                    ~~~~[0m

      [96msrc/tests/handlers/UtilityHandlers.test.ts[0m:[93m57[0m:[93m21[0m
        [7m57[0m       expect(result.data).toBeDefined();
        [7m  [0m [96m                    ~~~~[0m
        Did you forget to use 'await'?

FAIL src/tests/stripe-webhooks.test.ts
  ‚óè Test suite failed to run

    [96msrc/tests/stripe-webhooks.test.ts[0m:[93m324[0m:[93m23[0m - [91merror[0m[90m TS2304: [0mCannot find name 'express'.

    [7m324[0m       const testApp = express();
    [7m   [0m [91m                      ~~~~~~~[0m
    [96msrc/tests/stripe-webhooks.test.ts[0m:[93m325[0m:[93m19[0m - [91merror[0m[90m TS2304: [0mCannot find name 'express'.

    [7m325[0m       testApp.use(express.json());
    [7m   [0m [91m                  ~~~~~~~[0m

FAIL src/tests/invitations.test.ts
  ‚óè Test suite failed to run

    [96msrc/tests/invitations.test.ts[0m:[93m35[0m:[93m38[0m - [91merror[0m[90m TS2339: [0mProperty 'randomBytes' does not exist on type 'Crypto'.

    [7m35[0m       const invitationToken = crypto.randomBytes(32).toString('hex');
    [7m  [0m [91m                                     ~~~~~~~~~~~[0m
    [96msrc/tests/invitations.test.ts[0m:[93m86[0m:[93m23[0m - [91merror[0m[90m TS2339: [0mProperty 'randomBytes' does not exist on type 'Crypto'.

    [7m86[0m         token: crypto.randomBytes(32).toString('hex'),
    [7m  [0m [91m                      ~~~~~~~~~~~[0m
    [96msrc/tests/invitations.test.ts[0m:[93m117[0m:[93m38[0m - [91merror[0m[90m TS2339: [0mProperty 'randomBytes' does not exist on type 'Crypto'.

    [7m117[0m       const invitationToken = crypto.randomBytes(32).toString('hex');
    [7m   [0m [91m                                     ~~~~~~~~~~~[0m
    [96msrc/tests/invitations.test.ts[0m:[93m138[0m:[93m32[0m - [91merror[0m[90m TS2552: [0mCannot find name 'TeamMember'. Did you mean 'teamMember'?

    [7m138[0m       const teamMember = await TeamMember.findOne({
    [7m   [0m [91m                               ~~~~~~~~~~[0m

      [96msrc/tests/invitations.test.ts[0m:[93m138[0m:[93m13[0m
        [7m138[0m       const teamMember = await TeamMember.findOne({
        [7m   [0m [96m            ~~~~~~~~~~[0m
        'teamMember' is declared here.
    [96msrc/tests/invitations.test.ts[0m:[93m163[0m:[93m38[0m - [91merror[0m[90m TS2339: [0mProperty 'randomBytes' does not exist on type 'Crypto'.

    [7m163[0m       const invitationToken = crypto.randomBytes(32).toString('hex');
    [7m   [0m [91m                                     ~~~~~~~~~~~[0m
    [96msrc/tests/invitations.test.ts[0m:[93m192[0m:[93m38[0m - [91merror[0m[90m TS2339: [0mProperty 'randomBytes' does not exist on type 'Crypto'.

    [7m192[0m       const invitationToken = crypto.randomBytes(32).toString('hex');
    [7m   [0m [91m                                     ~~~~~~~~~~~[0m
    [96msrc/tests/invitations.test.ts[0m:[93m220[0m:[93m13[0m - [91merror[0m[90m TS2304: [0mCannot find name 'TeamMember'.

    [7m220[0m       await TeamMember.create({
    [7m   [0m [91m            ~~~~~~~~~~[0m
    [96msrc/tests/invitations.test.ts[0m:[93m227[0m:[93m38[0m - [91merror[0m[90m TS2339: [0mProperty 'randomBytes' does not exist on type 'Crypto'.

    [7m227[0m       const invitationToken = crypto.randomBytes(32).toString('hex');
    [7m   [0m [91m                                     ~~~~~~~~~~~[0m
    [96msrc/tests/invitations.test.ts[0m:[93m264[0m:[93m38[0m - [91merror[0m[90m TS2339: [0mProperty 'randomBytes' does not exist on type 'Crypto'.

    [7m264[0m       const invitationToken = crypto.randomBytes(32).toString('hex');
    [7m   [0m [91m                                     ~~~~~~~~~~~[0m
    [96msrc/tests/invitations.test.ts[0m:[93m287[0m:[93m32[0m - [91merror[0m[90m TS2552: [0mCannot find name 'TeamMember'. Did you mean 'teamMember'?

    [7m287[0m       const teamMember = await TeamMember.findOne({
    [7m   [0m [91m                               ~~~~~~~~~~[0m

      [96msrc/tests/invitations.test.ts[0m:[93m287[0m:[93m13[0m
        [7m287[0m       const teamMember = await TeamMember.findOne({
        [7m   [0m [96m            ~~~~~~~~~~[0m
        'teamMember' is declared here.
    [96msrc/tests/invitations.test.ts[0m:[93m306[0m:[93m38[0m - [91merror[0m[90m TS2339: [0mProperty 'randomBytes' does not exist on type 'Crypto'.

    [7m306[0m       const invitationToken = crypto.randomBytes(32).toString('hex');
    [7m   [0m [91m                                     ~~~~~~~~~~~[0m
    [96msrc/tests/invitations.test.ts[0m:[93m343[0m:[93m38[0m - [91merror[0m[90m TS2339: [0mProperty 'randomBytes' does not exist on type 'Crypto'.

    [7m343[0m       const invitationToken = crypto.randomBytes(32).toString('hex');
    [7m   [0m [91m                                     ~~~~~~~~~~~[0m
    [96msrc/tests/invitations.test.ts[0m:[93m383[0m:[93m38[0m - [91merror[0m[90m TS2339: [0mProperty 'randomBytes' does not exist on type 'Crypto'.

    [7m383[0m       const invitationToken = crypto.randomBytes(32).toString('hex');
    [7m   [0m [91m                                     ~~~~~~~~~~~[0m

Summary of all failing tests
FAIL src/tests/projects.test.ts (11.213 s)
  ‚óè Project CRUD Operations ‚Ä∫ DELETE /api/projects/:id ‚Ä∫ should delete project successfully

    expected 200 "OK", got 403 "Forbidden"

      260 |         .delete(`/api/projects/${projectId}`)
      261 |         .set('Cookie', `token=${authToken}`)
    > 262 |         .expect(200);
          |          ^
      263 |
      264 |       expect(response.body).toHaveProperty('message', 'Project deleted successfully');
      265 |

      at Object.<anonymous> (src/tests/projects.test.ts:262:10)
      ----
      at Test._assertStatus (node_modules/supertest/lib/test.js:309:14)
      at node_modules/supertest/lib/test.js:365:13
      at Test._assertFunction (node_modules/supertest/lib/test.js:342:13)
      at Test.assert (node_modules/supertest/lib/test.js:195:23)
      at localAssert (node_modules/supertest/lib/test.js:138:14)
      at Server.<anonymous> (node_modules/supertest/lib/test.js:152:11)

  ‚óè Project CRUD Operations ‚Ä∫ DELETE /api/projects/:id ‚Ä∫ should reject deletion for non-existent project

    expected 404 "Not Found", got 403 "Forbidden"

      274 |         .delete(`/api/projects/${fakeId}`)
      275 |         .set('Cookie', `token=${authToken}`)
    > 276 |         .expect(404);
          |          ^
      277 |
      278 |       expect(response.body).toHaveProperty('message', 'Project not found');
      279 |     });

      at Object.<anonymous> (src/tests/projects.test.ts:276:10)
      ----
      at Test._assertStatus (node_modules/supertest/lib/test.js:309:14)
      at node_modules/supertest/lib/test.js:365:13
      at Test._assertFunction (node_modules/supertest/lib/test.js:342:13)
      at Test.assert (node_modules/supertest/lib/test.js:195:23)
      at localAssert (node_modules/supertest/lib/test.js:138:14)
      at Server.<anonymous> (node_modules/supertest/lib/test.js:152:11)

  ‚óè Project CRUD Operations ‚Ä∫ Project Access Control ‚Ä∫ should deny access to other user's project

    expected 403 "Forbidden", got 200 "OK"

      370 |         .get(`/api/projects/${projectId}`)
      371 |         .set('Cookie', `token=${otherUserToken}`)
    > 372 |         .expect(403);
          |          ^
      373 |
      374 |       expect(response.body).toHaveProperty('message');
      375 |       expect(response.body.message).toContain('Access denied');

      at Object.<anonymous> (src/tests/projects.test.ts:372:10)
      ----
      at Test._assertStatus (node_modules/supertest/lib/test.js:309:14)
      at node_modules/supertest/lib/test.js:365:13
      at Test._assertFunction (node_modules/supertest/lib/test.js:342:13)
      at Test.assert (node_modules/supertest/lib/test.js:195:23)
      at localAssert (node_modules/supertest/lib/test.js:138:14)
      at Server.<anonymous> (node_modules/supertest/lib/test.js:152:11)

  ‚óè Project CRUD Operations ‚Ä∫ Project Access Control ‚Ä∫ should deny update access to other user's project

    expected 403 "Forbidden", got 200 "OK"

      385 |         .set('Cookie', `token=${otherUserToken}`)
      386 |         .send(updateData)
    > 387 |         .expect(403);
          |          ^
      388 |
      389 |       expect(response.body).toHaveProperty('message');
      390 |       expect(response.body.message).toContain('Access denied');

      at Object.<anonymous> (src/tests/projects.test.ts:387:10)
      ----
      at Test._assertStatus (node_modules/supertest/lib/test.js:309:14)
      at node_modules/supertest/lib/test.js:365:13
      at Test._assertFunction (node_modules/supertest/lib/test.js:342:13)
      at Test.assert (node_modules/supertest/lib/test.js:195:23)
      at localAssert (node_modules/supertest/lib/test.js:138:14)
      at Server.<anonymous> (node_modules/supertest/lib/test.js:152:11)

  ‚óè Project CRUD Operations ‚Ä∫ Project Access Control ‚Ä∫ should deny delete access to other user's project

    expect(received).toContain(expected) // indexOf

    Expected substring: "Access denied"
    Received string:    "Only project owner can delete the project"

      398 |
      399 |       expect(response.body).toHaveProperty('message');
    > 400 |       expect(response.body.message).toContain('Access denied');
          |                                     ^
      401 |     });
      402 |   });
      403 | });

      at Object.<anonymous> (src/tests/projects.test.ts:400:37)

FAIL src/tests/tickets.test.ts
  ‚óè Ticket Routes ‚Ä∫ POST /api/tickets ‚Ä∫ should create a new support ticket

    MongoServerError: E11000 duplicate key error collection: test.users index: username_1 dup key: { username: "testuser" }

      at node_modules/mongodb/src/operations/insert.ts:85:25
      at node_modules/mongodb/src/operations/command.ts:173:14

  ‚óè Ticket Routes ‚Ä∫ POST /api/tickets ‚Ä∫ should create ticket with default priority

    MongoServerError: E11000 duplicate key error collection: test.users index: username_1 dup key: { username: "testuser" }

      at node_modules/mongodb/src/operations/insert.ts:85:25
      at node_modules/mongodb/src/operations/command.ts:173:14

  ‚óè Ticket Routes ‚Ä∫ POST /api/tickets ‚Ä∫ should validate required fields

    MongoServerError: E11000 duplicate key error collection: test.users index: username_1 dup key: { username: "testuser" }

      at node_modules/mongodb/src/operations/insert.ts:85:25
      at node_modules/mongodb/src/operations/command.ts:173:14

  ‚óè Ticket Routes ‚Ä∫ POST /api/tickets ‚Ä∫ should validate category values

    MongoServerError: E11000 duplicate key error collection: test.users index: username_1 dup key: { username: "testuser" }

      at node_modules/mongodb/src/operations/insert.ts:85:25
      at node_modules/mongodb/src/operations/command.ts:173:14

  ‚óè Ticket Routes ‚Ä∫ POST /api/tickets ‚Ä∫ should validate priority values

    MongoServerError: E11000 duplicate key error collection: test.users index: username_1 dup key: { username: "testuser" }

      at node_modules/mongodb/src/operations/insert.ts:85:25
      at node_modules/mongodb/src/operations/command.ts:173:14

  ‚óè Ticket Routes ‚Ä∫ POST /api/tickets ‚Ä∫ should require authentication

    MongoServerError: E11000 duplicate key error collection: test.users index: username_1 dup key: { username: "testuser" }

      at node_modules/mongodb/src/operations/insert.ts:85:25
      at node_modules/mongodb/src/operations/command.ts:173:14

  ‚óè Ticket Routes ‚Ä∫ GET /api/tickets ‚Ä∫ should get user tickets with pagination

    MongoServerError: E11000 duplicate key error collection: test.users index: username_1 dup key: { username: "testuser" }

      at node_modules/mongodb/src/operations/insert.ts:85:25
      at node_modules/mongodb/src/operations/command.ts:173:14

  ‚óè Ticket Routes ‚Ä∫ GET /api/tickets ‚Ä∫ should filter tickets by status

    MongoServerError: E11000 duplicate key error collection: test.users index: username_1 dup key: { username: "testuser" }

      at node_modules/mongodb/src/operations/insert.ts:85:25
      at node_modules/mongodb/src/operations/command.ts:173:14

  ‚óè Ticket Routes ‚Ä∫ GET /api/tickets ‚Ä∫ should support pagination

    MongoServerError: E11000 duplicate key error collection: test.users index: username_1 dup key: { username: "testuser" }

      at node_modules/mongodb/src/operations/insert.ts:85:25
      at node_modules/mongodb/src/operations/command.ts:173:14

  ‚óè Ticket Routes ‚Ä∫ GET /api/tickets ‚Ä∫ should only return user own tickets

    MongoServerError: E11000 duplicate key error collection: test.users index: username_1 dup key: { username: "testuser" }

      at node_modules/mongodb/src/operations/insert.ts:85:25
      at node_modules/mongodb/src/operations/command.ts:173:14

  ‚óè Ticket Routes ‚Ä∫ GET /api/tickets/:ticketId ‚Ä∫ should get specific ticket

    MongoServerError: E11000 duplicate key error collection: test.users index: username_1 dup key: { username: "testuser" }

      at node_modules/mongodb/src/operations/insert.ts:85:25
      at node_modules/mongodb/src/operations/command.ts:173:14

  ‚óè Ticket Routes ‚Ä∫ GET /api/tickets/:ticketId ‚Ä∫ should return 404 for non-existent ticket

    MongoServerError: E11000 duplicate key error collection: test.users index: username_1 dup key: { username: "testuser" }

      at node_modules/mongodb/src/operations/insert.ts:85:25
      at node_modules/mongodb/src/operations/command.ts:173:14

  ‚óè Ticket Routes ‚Ä∫ GET /api/tickets/:ticketId ‚Ä∫ should not allow access to other users tickets

    MongoServerError: E11000 duplicate key error collection: test.users index: username_1 dup key: { username: "testuser" }

      at node_modules/mongodb/src/operations/insert.ts:85:25
      at node_modules/mongodb/src/operations/command.ts:173:14

FAIL src/tests/integration-auth-flow.test.ts (5.488 s)
  ‚óè Integration: Complete Auth Flow ‚Ä∫ Complete User Journey: Register ‚Üí Login ‚Üí Create Project ‚Üí Access Project ‚Ä∫ should allow full user workflow

    expect(received).toBe(expected) // Object.is equality

    Expected: 200
    Received: 403

      142 |         .set('Cookie', authCookie!);
      143 |
    > 144 |       expect(deleteProjectResponse.status).toBe(200);
          |                                            ^
      145 |       expect(deleteProjectResponse.body.message).toBe('Project deleted successfully');
      146 |
      147 |       // Verify project was deleted

      at Object.<anonymous> (src/tests/integration-auth-flow.test.ts:144:44)

  ‚óè Integration: Complete Auth Flow ‚Ä∫ Complete User Journey: Register ‚Üí Login ‚Üí Create Project ‚Üí Access Project ‚Ä∫ should support full project with todos workflow

    expect(received).toBe(expected) // Object.is equality

    Expected: 200
    Received: 400

      191 |         .send({ title: 'Test todo', priority: 'high' });
      192 |
    > 193 |       expect(todoResponse.status).toBe(200);
          |                                   ^
      194 |       expect(todoResponse.body.todo).toBeDefined();
      195 |       const todoId = todoResponse.body.todo.id;
      196 |

      at Object.<anonymous> (src/tests/integration-auth-flow.test.ts:193:35)

  ‚óè Integration: Complete Auth Flow ‚Ä∫ Authentication Security Flow ‚Ä∫ should prevent access to other users projects

    expect(received).toBe(expected) // Object.is equality

    Expected: 403
    Received: 200

      307 |         .set('Cookie', secondCookie!);
      308 |
    > 309 |       expect(accessResponse.status).toBe(403); // Should deny access to different user's project
          |                                     ^
      310 |     });
      311 |   });
      312 |

      at Object.<anonymous> (src/tests/integration-auth-flow.test.ts:309:37)

FAIL src/tests/services/activityLogger.test.ts
  ‚óè ActivityLogger Service ‚Ä∫ log ‚Ä∫ should include metadata

    ValidationError: ActivityLog validation failed: action: `todo_created` is not a valid enum value for path `action`.

      at model.Document.invalidate (node_modules/mongoose/lib/document.js:3219:32)
      at node_modules/mongoose/lib/document.js:3012:17
      at node_modules/mongoose/lib/schematype.js:1368:9

  ‚óè ActivityLogger Service ‚Ä∫ getProjectActivities ‚Ä∫ should get activities for a project

    ValidationError: ActivityLog validation failed: action: `action_0` is not a valid enum value for path `action`.

      at model.Document.invalidate (node_modules/mongoose/lib/document.js:3219:32)
      at node_modules/mongoose/lib/document.js:3012:17
      at node_modules/mongoose/lib/schematype.js:1368:9

  ‚óè ActivityLogger Service ‚Ä∫ getProjectActivities ‚Ä∫ should support pagination

    ValidationError: ActivityLog validation failed: action: `action_0` is not a valid enum value for path `action`.

      at model.Document.invalidate (node_modules/mongoose/lib/document.js:3219:32)
      at node_modules/mongoose/lib/document.js:3012:17
      at node_modules/mongoose/lib/schematype.js:1368:9

  ‚óè ActivityLogger Service ‚Ä∫ getProjectActivities ‚Ä∫ should filter by user

    ValidationError: ActivityLog validation failed: action: `action_0` is not a valid enum value for path `action`.

      at model.Document.invalidate (node_modules/mongoose/lib/document.js:3219:32)
      at node_modules/mongoose/lib/document.js:3012:17
      at node_modules/mongoose/lib/schematype.js:1368:9

  ‚óè ActivityLogger Service ‚Ä∫ getProjectActivities ‚Ä∫ should filter by date range

    ValidationError: ActivityLog validation failed: action: `action_0` is not a valid enum value for path `action`.

      at model.Document.invalidate (node_modules/mongoose/lib/document.js:3219:32)
      at node_modules/mongoose/lib/document.js:3012:17
      at node_modules/mongoose/lib/schematype.js:1368:9

  ‚óè ActivityLogger Service ‚Ä∫ getUserActivities ‚Ä∫ should get activities for a user

    ValidationError: ActivityLog validation failed: action: `user_action_0` is not a valid enum value for path `action`.

      at model.Document.invalidate (node_modules/mongoose/lib/document.js:3219:32)
      at node_modules/mongoose/lib/document.js:3012:17
      at node_modules/mongoose/lib/schematype.js:1368:9

  ‚óè ActivityLogger Service ‚Ä∫ getUserActivities ‚Ä∫ should filter by project

    ValidationError: ActivityLog validation failed: action: `user_action_0` is not a valid enum value for path `action`.

      at model.Document.invalidate (node_modules/mongoose/lib/document.js:3219:32)
      at node_modules/mongoose/lib/document.js:3012:17
      at node_modules/mongoose/lib/schematype.js:1368:9

  ‚óè ActivityLogger Service ‚Ä∫ getRecentActivity ‚Ä∫ should get recent activity

    ValidationError: ActivityLog validation failed: action: `recent_action` is not a valid enum value for path `action`.

      at model.Document.invalidate (node_modules/mongoose/lib/document.js:3219:32)
      at node_modules/mongoose/lib/document.js:3012:17
      at node_modules/mongoose/lib/schematype.js:1368:9

FAIL src/tests/public.test.ts
  ‚óè Public Routes ‚Ä∫ GET /api/public/user/:identifier ‚Ä∫ should get public user profile

    expected 200 "OK", got 404 "Not Found"

      199 |       const response = await request(app)
      200 |         .get('/api/public/user/profile-user')
    > 201 |         .expect(200);
          |          ^
      202 |
      203 |       expect(response.body).toHaveProperty('success', true);
      204 |       expect(response.body.user).toHaveProperty('username', 'profileuser');

      at Object.<anonymous> (src/tests/public.test.ts:201:10)
      ----
      at Test._assertStatus (node_modules/supertest/lib/test.js:309:14)
      at node_modules/supertest/lib/test.js:365:13
      at Test._assertFunction (node_modules/supertest/lib/test.js:342:13)
      at Test.assert (node_modules/supertest/lib/test.js:195:23)
      at localAssert (node_modules/supertest/lib/test.js:138:14)
      at Server.<anonymous> (node_modules/supertest/lib/test.js:152:11)

  ‚óè Public Routes ‚Ä∫ GET /api/public/user/:identifier/projects ‚Ä∫ should get public projects for user

    expected 200 "OK", got 404 "Not Found"

      276 |       const response = await request(app)
      277 |         .get('/api/public/user/projects-user/projects')
    > 278 |         .expect(200);
          |          ^
      279 |
      280 |       expect(response.body).toHaveProperty('projects');
      281 |       expect(Array.isArray(response.body.projects)).toBe(true);

      at Object.<anonymous> (src/tests/public.test.ts:278:10)
      ----
      at Test._assertStatus (node_modules/supertest/lib/test.js:309:14)
      at node_modules/supertest/lib/test.js:365:13
      at Test._assertFunction (node_modules/supertest/lib/test.js:342:13)
      at Test.assert (node_modules/supertest/lib/test.js:195:23)
      at localAssert (node_modules/supertest/lib/test.js:138:14)
      at Server.<anonymous> (node_modules/supertest/lib/test.js:152:11)

FAIL src/tests/handlers/StackHandlers.test.ts
  ‚óè StackHandlers ‚Ä∫ handleAddStack ‚Ä∫ should add stack item with minimal fields

    expect(received).toBe(expected) // Object.is equality

    Expected: "Express"
    Received: "Express.js"

      142 |
      143 |       expect(result.type).toBe(ResponseType.SUCCESS);
    > 144 |       expect(mockProject.stack[0].name).toBe('Express');
          |                                         ^
      145 |     });
      146 |   });
      147 |

      at Object.<anonymous> (src/tests/handlers/StackHandlers.test.ts:144:41)

  ‚óè StackHandlers ‚Ä∫ handleViewStack ‚Ä∫ should filter by category

    expect(received).toHaveLength(expected)

    Expected length: 1
    Received length: 3
    Received array:  [{"category": "framework", "description": "", "name": "React", "version": "18.2.0"}, {"category": "api", "description": "", "name": "Express", "version": "4.18.0"}, {"category": "database", "description": "", "name": "MongoDB", "version": "6.0"}]

      192 |
      193 |       expect(result.type).toBe(ResponseType.DATA);
    > 194 |       expect(result.data.stack).toHaveLength(1);
          |                                 ^
      195 |       expect(result.data.stack[0].name).toBe('React');
      196 |     });
      197 |   });

      at Object.<anonymous> (src/tests/handlers/StackHandlers.test.ts:194:33)

  ‚óè StackHandlers ‚Ä∫ handleRemoveStack ‚Ä∫ should remove stack item

    expect(received).toBe(expected) // Object.is equality

    Expected: "success"
    Received: "error"

      221 |       const result = await handler.handleRemoveStack(parsed, projectId);
      222 |
    > 223 |       expect(result.type).toBe(ResponseType.SUCCESS);
          |                           ^
      224 |       expect(mockProject.stack).toHaveLength(1);
      225 |       expect(mockProject.stack[0].id).toBe('2');
      226 |       expect(mockProject.save).toHaveBeenCalled();

      at Object.<anonymous> (src/tests/handlers/StackHandlers.test.ts:223:27)

FAIL src/tests/integration-project-lifecycle.test.ts
  ‚óè Integration: Project Lifecycle ‚Ä∫ should handle full project CRUD workflow

    expect(received).toBe(expected) // Object.is equality

    Expected: 200
    Received: 403

      79 |       .set('Cookie', userCookie);
      80 |
    > 81 |     expect(deleteRes.status).toBe(200);
         |                              ^
      82 |   });
      83 | });
      84 |

      at Object.<anonymous> (src/tests/integration-project-lifecycle.test.ts:81:30)

FAIL src/tests/integration-billing.test.ts
  ‚óè Integration: Billing & Subscription Limits ‚Ä∫ should allow more projects after upgrading plan

    expect(received).toBeTruthy()

    Received: null

      85 |     // Upgrade to pro
      86 |     const dbUser = await User.findOne({ email: user.email });
    > 87 |     expect(dbUser).toBeTruthy();
         |                    ^
      88 |     
      89 |     dbUser!.planTier = 'pro';
      90 |     dbUser!.projectLimit = 10;

      at Object.<anonymous> (src/tests/integration-billing.test.ts:87:20)

FAIL src/tests/integration-team-collaboration.test.ts
  ‚óè Integration: Team Collaboration ‚Ä∫ should handle team invitation workflow

    TypeError: Invalid value "undefined" for header "Cookie"

      at Test.setHeader [as request] (node_modules/superagent/src/node/index.js:830:39)
      at Test.request [as end] (node_modules/superagent/src/node/index.js:965:8)
      at Test.end (node_modules/supertest/lib/test.js:136:11)
      at end (node_modules/superagent/src/request-base.js:283:12)
      at Test.RequestBase.then (node_modules/superagent/src/request-base.js:265:31)

FAIL src/tests/middleware-auth.test.ts
  ‚óè Auth Middleware ‚Ä∫ requireAuth ‚Ä∫ should authenticate valid token

    expect(jest.fn()).toHaveBeenCalledWith(...expected)

    Expected: "valid-token", "test-secret"

    Number of calls: 0

      57 |       requireAuth(mockReq as AuthRequest, mockRes as Response, mockNext);
      58 |
    > 59 |       expect(jwt.verify).toHaveBeenCalledWith('valid-token', 'test-secret');
         |                          ^
      60 |       expect(mockReq.userId).toBe(mockUserId);
      61 |       expect(mockNext).toHaveBeenCalled();
      62 |     });

      at Object.<anonymous> (src/tests/middleware-auth.test.ts:59:26)

  ‚óè Auth Middleware ‚Ä∫ requireAuth ‚Ä∫ should handle expired token

    expect(jest.fn()).toHaveBeenCalledWith(...expected)

    - Expected
    + Received

      Object {
    -   "message": "Token expired",
    +   "message": "Invalid token",
      },

    Number of calls: 1

       98 |
       99 |       expect(mockRes.status).toHaveBeenCalledWith(401);
    > 100 |       expect(mockRes.json).toHaveBeenCalledWith({ message: 'Token expired' });
          |                            ^
      101 |       expect(mockNext).not.toHaveBeenCalled();
      102 |     });
      103 |

      at Object.<anonymous> (src/tests/middleware-auth.test.ts:100:28)

  ‚óè Auth Middleware ‚Ä∫ requireAuth ‚Ä∫ should handle missing JWT_SECRET

    expect(jest.fn()).toHaveBeenCalledWith(...expected)

    Expected: 500
    Received: 401

    Number of calls: 1

      108 |       requireAuth(mockReq as AuthRequest, mockRes as Response, mockNext);
      109 |
    > 110 |       expect(mockRes.status).toHaveBeenCalledWith(500);
          |                              ^
      111 |       expect(mockRes.json).toHaveBeenCalledWith({ message: 'Server configuration error' });
      112 |       expect(mockNext).not.toHaveBeenCalled();
      113 |     });

      at Object.<anonymous> (src/tests/middleware-auth.test.ts:110:30)

  ‚óè Auth Middleware ‚Ä∫ requireProjectAccess ‚Ä∫ should grant access to project owner

    expect(received).toEqual(expected) // deep equality

    Expected: {"canEdit": true, "canManageTeam": true, "isOwner": true, "role": "owner"}
    Received: undefined

      149 |       await middleware(mockReq as AuthRequest, mockRes as Response, mockNext);
      150 |
    > 151 |       expect(mockReq.projectAccess).toEqual({
          |                                     ^
      152 |         isOwner: true,
      153 |         role: 'owner',
      154 |         canEdit: true,

      at Object.<anonymous> (src/tests/middleware-auth.test.ts:151:37)

  ‚óè Auth Middleware ‚Ä∫ requireProjectAccess ‚Ä∫ should grant access to team member with editor role

    expect(received).toEqual(expected) // deep equality

    Expected: {"canEdit": true, "canManageTeam": false, "isOwner": false, "role": "editor"}
    Received: undefined

      177 |       await middleware(mockReq as AuthRequest, mockRes as Response, mockNext);
      178 |
    > 179 |       expect(mockReq.projectAccess).toEqual({
          |                                     ^
      180 |         isOwner: false,
      181 |         role: 'editor',
      182 |         canEdit: true,

      at Object.<anonymous> (src/tests/middleware-auth.test.ts:179:37)

  ‚óè Auth Middleware ‚Ä∫ requireProjectAccess ‚Ä∫ should grant limited access to team member with viewer role

    expect(received).toEqual(expected) // deep equality

    Expected: {"canEdit": false, "canManageTeam": false, "isOwner": false, "role": "viewer"}
    Received: undefined

      205 |       await middleware(mockReq as AuthRequest, mockRes as Response, mockNext);
      206 |
    > 207 |       expect(mockReq.projectAccess).toEqual({
          |                                     ^
      208 |         isOwner: false,
      209 |         role: 'viewer',
      210 |         canEdit: false,

      at Object.<anonymous> (src/tests/middleware-auth.test.ts:207:37)

  ‚óè Auth Middleware ‚Ä∫ requireProjectAccess ‚Ä∫ should deny access if project not found

    expect(jest.fn()).toHaveBeenCalledWith(...expected)

    Expected: 404

    Number of calls: 0

      220 |       await middleware(mockReq as AuthRequest, mockRes as Response, mockNext);
      221 |
    > 222 |       expect(mockRes.status).toHaveBeenCalledWith(404);
          |                              ^
      223 |       expect(mockRes.json).toHaveBeenCalledWith({ message: 'Project not found' });
      224 |       expect(mockNext).not.toHaveBeenCalled();
      225 |     });

      at Object.<anonymous> (src/tests/middleware-auth.test.ts:222:30)

  ‚óè Auth Middleware ‚Ä∫ requireProjectAccess ‚Ä∫ should deny access if user has no permissions

    expect(jest.fn()).toHaveBeenCalledWith(...expected)

    Expected: 403

    Number of calls: 0

      237 |       await middleware(mockReq as AuthRequest, mockRes as Response, mockNext);
      238 |
    > 239 |       expect(mockRes.status).toHaveBeenCalledWith(403);
          |                              ^
      240 |       expect(mockRes.json).toHaveBeenCalledWith({ message: 'Access denied: Not a team member' });
      241 |       expect(mockNext).not.toHaveBeenCalled();
      242 |     });

      at Object.<anonymous> (src/tests/middleware-auth.test.ts:239:30)

  ‚óè Auth Middleware ‚Ä∫ requireProjectAccess ‚Ä∫ should deny access for edit permission when user only has view access

    expect(jest.fn()).toHaveBeenCalledWith(...expected)

    Expected: 403

    Number of calls: 0

      260 |       await middleware(mockReq as AuthRequest, mockRes as Response, mockNext);
      261 |
    > 262 |       expect(mockRes.status).toHaveBeenCalledWith(403);
          |                              ^
      263 |       expect(mockRes.json).toHaveBeenCalledWith({ message: 'Access denied: Edit permission required' });
      264 |       expect(mockNext).not.toHaveBeenCalled();
      265 |     });

      at Object.<anonymous> (src/tests/middleware-auth.test.ts:262:30)

  ‚óè Auth Middleware ‚Ä∫ requireProjectAccess ‚Ä∫ should handle database errors

    expect(jest.fn()).toHaveBeenCalledWith(...expected)

    Expected: 500

    Number of calls: 0

      271 |       await middleware(mockReq as AuthRequest, mockRes as Response, mockNext);
      272 |
    > 273 |       expect(mockRes.status).toHaveBeenCalledWith(500);
          |                              ^
      274 |       expect(mockRes.json).toHaveBeenCalledWith({ message: 'Server error checking project access' });
      275 |       expect(mockNext).not.toHaveBeenCalled();
      276 |     });

      at Object.<anonymous> (src/tests/middleware-auth.test.ts:273:30)

  ‚óè Auth Middleware ‚Ä∫ requireProjectAccess ‚Ä∫ should require authentication first

    expect(jest.fn()).toHaveBeenCalledWith(...expected)

    - Expected
    + Received

      Object {
    -   "message": "Missing authentication or project ID",
    +   "message": "Not authenticated",
      },

    Number of calls: 1

      283 |
      284 |       expect(mockRes.status).toHaveBeenCalledWith(401);
    > 285 |       expect(mockRes.json).toHaveBeenCalledWith({ message: 'Missing authentication or project ID' });
          |                            ^
      286 |       expect(mockNext).not.toHaveBeenCalled();
      287 |     });
      288 |

      at Object.<anonymous> (src/tests/middleware-auth.test.ts:285:28)

  ‚óè Auth Middleware ‚Ä∫ requireProjectAccess ‚Ä∫ should require project ID in params

    expect(jest.fn()).toHaveBeenCalledWith(...expected)

    Expected: 401

    Number of calls: 0

      293 |       await middleware(mockReq as AuthRequest, mockRes as Response, mockNext);
      294 |
    > 295 |       expect(mockRes.status).toHaveBeenCalledWith(401);
          |                              ^
      296 |       expect(mockRes.json).toHaveBeenCalledWith({ message: 'Missing authentication or project ID' });
      297 |       expect(mockNext).not.toHaveBeenCalled();
      298 |     });

      at Object.<anonymous> (src/tests/middleware-auth.test.ts:295:30)

  ‚óè Auth Middleware ‚Ä∫ requireProjectAccess ‚Ä∫ should allow team management for owner role

    expect(received).toEqual(expected) // deep equality

    Expected: {"canEdit": true, "canManageTeam": true, "isOwner": false, "role": "owner"}
    Received: undefined

      316 |       await middleware(mockReq as AuthRequest, mockRes as Response, mockNext);
      317 |
    > 318 |       expect(mockReq.projectAccess).toEqual({
          |                                     ^
      319 |         isOwner: false,
      320 |         role: 'owner',
      321 |         canEdit: true,

      at Object.<anonymous> (src/tests/middleware-auth.test.ts:318:37)

FAIL src/tests/handlers/SettingsHandlers.test.ts
  ‚óè SettingsHandlers ‚Ä∫ handleSetName ‚Ä∫ should validate empty name

    expect(received).toContain(expected) // indexOf

    Expected substring: "valid"
    Received string:    "Project name cannot be empty"

       96 |
       97 |       expect(result.type).toBe(ResponseType.ERROR);
    >  98 |       expect(result.message).toContain('valid');
          |                              ^
       99 |     });
      100 |   });
      101 |

      at Object.<anonymous> (src/tests/handlers/SettingsHandlers.test.ts:98:30)

  ‚óè SettingsHandlers ‚Ä∫ handleSetPublic ‚Ä∫ should set project to public

    expect(received).toBe(expected) // Object.is equality

    Expected: "success"
    Received: "error"

      266 |       const result = await handler.handleSetPublic(parsed, projectId);
      267 |
    > 268 |       expect(result.type).toBe(ResponseType.SUCCESS);
          |                           ^
      269 |       expect(mockProject.isPublic).toBe(true);
      270 |       expect(mockProject.save).toHaveBeenCalled();
      271 |     });

      at Object.<anonymous> (src/tests/handlers/SettingsHandlers.test.ts:268:27)

  ‚óè SettingsHandlers ‚Ä∫ handleSetPublic ‚Ä∫ should set project to private

    expect(received).toBe(expected) // Object.is equality

    Expected: "success"
    Received: "error"

      288 |       const result = await handler.handleSetPublic(parsed, projectId);
      289 |
    > 290 |       expect(result.type).toBe(ResponseType.SUCCESS);
          |                           ^
      291 |       expect(mockProject.isPublic).toBe(false);
      292 |       expect(mockProject.save).toHaveBeenCalled();
      293 |     });

      at Object.<anonymous> (src/tests/handlers/SettingsHandlers.test.ts:290:27)

FAIL src/tests/services/emailService.test.ts
  ‚óè emailService ‚Ä∫ sendProjectInvitationEmail ‚Ä∫ should send invitation email with correct details

    expect(jest.fn()).toHaveBeenCalledWith(...expected)

    Expected: ObjectContaining {"subject": StringContaining "invitation", "to": "invitee@example.com"}
    Received: {"from": "\"Project Manager\" <test@example.com>", "html": "
        <!DOCTYPE html>
        <html>
        <head>
          <meta charset=\"utf-8\">
          <title>Project Invitation</title>
          <style>
            body {
              font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
              line-height: 1.6;
              color: #333;
              max-width: 600px;
              margin: 0 auto;
              padding: 20px;
            }
            .header {
              text-align: center;
              padding: 30px 0;
              border-bottom: 2px solid #3B82F6;
            }
            .content {
              padding: 30px 0;
            }
            .cta-button {
              display: inline-block;
              background-color: #3B82F6;
              color: white;
              padding: 12px 30px;
              text-decoration: none;
              border-radius: 6px;
              font-weight: 600;
              margin: 20px 0;
            }
            .cta-button:hover {
              background-color: #2563EB;
            }
            .footer {
              margin-top: 40px;
              padding-top: 20px;
              border-top: 1px solid #e5e7eb;
              font-size: 14px;
              color: #6b7280;
            }
            .project-info {
              background-color: #f8fafc;
              padding: 20px;
              border-radius: 8px;
              margin: 20px 0;
            }
          </style>
        </head>
        <body>
          <div class=\"header\">
            <h1>ÔøΩÔøΩ Project Manager</h1>
            <h2>You're invited to collaborate!</h2>
          </div>¬∑¬∑¬∑¬∑¬∑¬∑¬∑
          <div class=\"content\">
            <p>Hi there!</p>¬∑¬∑¬∑¬∑¬∑¬∑¬∑¬∑¬∑
            <p><strong>John Doe</strong> has invited you to collaborate on their project as a <strong>editor</strong>.</p>¬∑¬∑¬∑¬∑¬∑¬∑¬∑¬∑¬∑
            <div class=\"project-info\">
              <h3>ÔøΩÔøΩ Project: Test Project</h3>
              <p><strong>Your role:</strong> Editor</p>
            </div>¬∑¬∑¬∑¬∑¬∑¬∑¬∑¬∑¬∑
            <p>Click the button below to accept the invitation and start collaborating:</p>¬∑¬∑¬∑¬∑¬∑¬∑¬∑¬∑¬∑
            <div style=\"text-align: center;\">
              <a href=\"http://localhost:5002/invitation/test-token-123\" class=\"cta-button\">Accept Invitation</a>
            </div>¬∑¬∑¬∑¬∑¬∑¬∑¬∑¬∑¬∑
            <p>Or copy and paste this link into your browser:</p>
            <p><a href=\"http://localhost:5002/invitation/test-token-123\">http://localhost:5002/invitation/test-token-123</a></p>¬∑¬∑¬∑¬∑¬∑¬∑¬∑¬∑¬∑
            <p>This invitation will expire in 7 days. If you don't have an account yet, you'll be able to create one during the acceptance process.</p>
          </div>¬∑¬∑¬∑¬∑¬∑¬∑¬∑
          <div class=\"footer\">
            <p>This invitation was sent by John Doe through Project Manager.</p>
            <p>If you weren't expecting this invitation, you can safely ignore this email.</p>
          </div>
        </body>
        </html>
      ", "subject": "You're invited to collaborate on \"Test Project\"", "text": "
    Project Manager - Collaboration Invitation¬∑
    Hi there!¬∑
    John Doe has invited you to collaborate on their project \"Test Project\" as a editor.¬∑
    Accept your invitation by visiting this link:
    http://localhost:5002/invitation/test-token-123¬∑
    This invitation will expire in 7 days. If you don't have an account yet, you'll be able to create one during the acceptance process.¬∑
    If you weren't expecting this invitation, you can safely ignore this email.¬∑
    ---
    Project Manager Team
      ", "to": "invitee@example.com"}

    Number of calls: 1

      37 |
      38 |       expect(nodemailer.createTransport).toHaveBeenCalled();
    > 39 |       expect(mockSendMail).toHaveBeenCalledWith(
         |                            ^
      40 |         expect.objectContaining({
      41 |           to: 'invitee@example.com',
      42 |           subject: expect.stringContaining('invitation')

      at Object.<anonymous> (src/tests/services/emailService.test.ts:39:28)

FAIL src/tests/services/cleanupService.test.ts
  ‚óè Test suite failed to run

    [96msrc/tests/services/cleanupService.test.ts[0m:[93m43[0m:[93m27[0m - [91merror[0m[90m TS2540: [0mCannot assign to 'db' because it is a read-only property.

    [7m43[0m       mongoose.connection.db = {
    [7m  [0m [91m                          ~~[0m
    [96msrc/tests/services/cleanupService.test.ts[0m:[93m110[0m:[93m21[0m - [91merror[0m[90m TS2339: [0mProperty 'expired' does not exist on type '{ markedExpired: number; message: string; }'.

    [7m110[0m       expect(result.expired).toBe(10);
    [7m   [0m [91m                    ~~~~~~~[0m
    [96msrc/tests/services/cleanupService.test.ts[0m:[93m111[0m:[93m21[0m - [91merror[0m[90m TS2339: [0mProperty 'deleted' does not exist on type '{ markedExpired: number; message: string; }'.

    [7m111[0m       expect(result.deleted).toBe(5);
    [7m   [0m [91m                    ~~~~~~~[0m

FAIL src/tests/handlers/UtilityHandlers.test.ts
  ‚óè Test suite failed to run

    [96msrc/tests/handlers/UtilityHandlers.test.ts[0m:[93m32[0m:[93m45[0m - [91merror[0m[90m TS2554: [0mExpected 1 arguments, but got 2.

    [7m32[0m     handler = new UtilityHandlers(mockUser, mockProject);
    [7m  [0m [91m                                            ~~~~~~~~~~~[0m
    [96msrc/tests/handlers/UtilityHandlers.test.ts[0m:[93m54[0m:[93m30[0m - [91merror[0m[90m TS2554: [0mExpected 1-2 arguments, but got 0.

    [7m54[0m       const result = handler.handleLLMContext();
    [7m  [0m [91m                             ~~~~~~~~~~~~~~~~[0m

      [96msrc/services/handlers/UtilityHandlers.ts[0m:[93m1768[0m:[93m26[0m
        [7m1768[0m   async handleLLMContext(parsed: ParsedCommand, currentProjectId?: string): Promise<CommandResponse> {
        [7m    [0m [96m                         ~~~~~~~~~~~~~~~~~~~~~[0m
        An argument for 'parsed' was not provided.
    [96msrc/tests/handlers/UtilityHandlers.test.ts[0m:[93m56[0m:[93m21[0m - [91merror[0m[90m TS2339: [0mProperty 'type' does not exist on type 'Promise<CommandResponse>'.

    [7m56[0m       expect(result.type).toBe('info');
    [7m  [0m [91m                    ~~~~[0m

      [96msrc/tests/handlers/UtilityHandlers.test.ts[0m:[93m56[0m:[93m21[0m
        [7m56[0m       expect(result.type).toBe('info');
        [7m  [0m [96m                    ~~~~[0m
        Did you forget to use 'await'?
    [96msrc/tests/handlers/UtilityHandlers.test.ts[0m:[93m57[0m:[93m21[0m - [91merror[0m[90m TS2339: [0mProperty 'data' does not exist on type 'Promise<CommandResponse>'.

    [7m57[0m       expect(result.data).toBeDefined();
    [7m  [0m [91m                    ~~~~[0m

      [96msrc/tests/handlers/UtilityHandlers.test.ts[0m:[93m57[0m:[93m21[0m
        [7m57[0m       expect(result.data).toBeDefined();
        [7m  [0m [96m                    ~~~~[0m
        Did you forget to use 'await'?

FAIL src/tests/stripe-webhooks.test.ts
  ‚óè Test suite failed to run

    [96msrc/tests/stripe-webhooks.test.ts[0m:[93m324[0m:[93m23[0m - [91merror[0m[90m TS2304: [0mCannot find name 'express'.

    [7m324[0m       const testApp = express();
    [7m   [0m [91m                      ~~~~~~~[0m
    [96msrc/tests/stripe-webhooks.test.ts[0m:[93m325[0m:[93m19[0m - [91merror[0m[90m TS2304: [0mCannot find name 'express'.

    [7m325[0m       testApp.use(express.json());
    [7m   [0m [91m                  ~~~~~~~[0m

FAIL src/tests/invitations.test.ts
  ‚óè Test suite failed to run

    [96msrc/tests/invitations.test.ts[0m:[93m35[0m:[93m38[0m - [91merror[0m[90m TS2339: [0mProperty 'randomBytes' does not exist on type 'Crypto'.

    [7m35[0m       const invitationToken = crypto.randomBytes(32).toString('hex');
    [7m  [0m [91m                                     ~~~~~~~~~~~[0m
    [96msrc/tests/invitations.test.ts[0m:[93m86[0m:[93m23[0m - [91merror[0m[90m TS2339: [0mProperty 'randomBytes' does not exist on type 'Crypto'.

    [7m86[0m         token: crypto.randomBytes(32).toString('hex'),
    [7m  [0m [91m                      ~~~~~~~~~~~[0m
    [96msrc/tests/invitations.test.ts[0m:[93m117[0m:[93m38[0m - [91merror[0m[90m TS2339: [0mProperty 'randomBytes' does not exist on type 'Crypto'.

    [7m117[0m       const invitationToken = crypto.randomBytes(32).toString('hex');
    [7m   [0m [91m                                     ~~~~~~~~~~~[0m
    [96msrc/tests/invitations.test.ts[0m:[93m138[0m:[93m32[0m - [91merror[0m[90m TS2552: [0mCannot find name 'TeamMember'. Did you mean 'teamMember'?

    [7m138[0m       const teamMember = await TeamMember.findOne({
    [7m   [0m [91m                               ~~~~~~~~~~[0m

      [96msrc/tests/invitations.test.ts[0m:[93m138[0m:[93m13[0m
        [7m138[0m       const teamMember = await TeamMember.findOne({
        [7m   [0m [96m            ~~~~~~~~~~[0m
        'teamMember' is declared here.
    [96msrc/tests/invitations.test.ts[0m:[93m163[0m:[93m38[0m - [91merror[0m[90m TS2339: [0mProperty 'randomBytes' does not exist on type 'Crypto'.

    [7m163[0m       const invitationToken = crypto.randomBytes(32).toString('hex');
    [7m   [0m [91m                                     ~~~~~~~~~~~[0m
    [96msrc/tests/invitations.test.ts[0m:[93m192[0m:[93m38[0m - [91merror[0m[90m TS2339: [0mProperty 'randomBytes' does not exist on type 'Crypto'.

    [7m192[0m       const invitationToken = crypto.randomBytes(32).toString('hex');
    [7m   [0m [91m                                     ~~~~~~~~~~~[0m
    [96msrc/tests/invitations.test.ts[0m:[93m220[0m:[93m13[0m - [91merror[0m[90m TS2304: [0mCannot find name 'TeamMember'.

    [7m220[0m       await TeamMember.create({
    [7m   [0m [91m            ~~~~~~~~~~[0m
    [96msrc/tests/invitations.test.ts[0m:[93m227[0m:[93m38[0m - [91merror[0m[90m TS2339: [0mProperty 'randomBytes' does not exist on type 'Crypto'.

    [7m227[0m       const invitationToken = crypto.randomBytes(32).toString('hex');
    [7m   [0m [91m                                     ~~~~~~~~~~~[0m
    [96msrc/tests/invitations.test.ts[0m:[93m264[0m:[93m38[0m - [91merror[0m[90m TS2339: [0mProperty 'randomBytes' does not exist on type 'Crypto'.

    [7m264[0m       const invitationToken = crypto.randomBytes(32).toString('hex');
    [7m   [0m [91m                                     ~~~~~~~~~~~[0m
    [96msrc/tests/invitations.test.ts[0m:[93m287[0m:[93m32[0m - [91merror[0m[90m TS2552: [0mCannot find name 'TeamMember'. Did you mean 'teamMember'?

    [7m287[0m       const teamMember = await TeamMember.findOne({
    [7m   [0m [91m                               ~~~~~~~~~~[0m

      [96msrc/tests/invitations.test.ts[0m:[93m287[0m:[93m13[0m
        [7m287[0m       const teamMember = await TeamMember.findOne({
        [7m   [0m [96m            ~~~~~~~~~~[0m
        'teamMember' is declared here.
    [96msrc/tests/invitations.test.ts[0m:[93m306[0m:[93m38[0m - [91merror[0m[90m TS2339: [0mProperty 'randomBytes' does not exist on type 'Crypto'.

    [7m306[0m       const invitationToken = crypto.randomBytes(32).toString('hex');
    [7m   [0m [91m                                     ~~~~~~~~~~~[0m
    [96msrc/tests/invitations.test.ts[0m:[93m343[0m:[93m38[0m - [91merror[0m[90m TS2339: [0mProperty 'randomBytes' does not exist on type 'Crypto'.

    [7m343[0m       const invitationToken = crypto.randomBytes(32).toString('hex');
    [7m   [0m [91m                                     ~~~~~~~~~~~[0m
    [96msrc/tests/invitations.test.ts[0m:[93m383[0m:[93m38[0m - [91merror[0m[90m TS2339: [0mProperty 'randomBytes' does not exist on type 'Crypto'.

    [7m383[0m       const invitationToken = crypto.randomBytes(32).toString('hex');
    [7m   [0m [91m                                     ~~~~~~~~~~~[0m


Test Suites: 16 failed, 30 passed, 46 total
Tests:       54 failed, 489 passed, 543 total
Snapshots:   0 total
Time:        129.171 s
Ran all test suites.
2025-11-11 15:37:34 [[32MINFO[39M]: Project cache cleared | {"service":"dev-codex-backend","environment":"test","entriesCleared":0,"pid":1362174}
2025-11-11 15:37:34 [[32MINFO[39M]: Project cache destroyed and resources cleaned up | {"service":"dev-codex-backend","environment":"test","pid":1362174}
Global test database stopped and resources cleaned up
